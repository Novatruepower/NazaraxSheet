<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Sheet</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Google Identity Services for OAuth 2.0 -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #333;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        /* Style for the placeholder-like text in the select element itself */
        .select-placeholder-text {
            color: #9ca3af; /* text-gray-400 */
        }

        .select-placeholder-text:focus {
            color: black; /* text-gray-400 */
        }

        .defaultOption {
            display: none;
        }
        /* Specific styling for table inputs to make them compact */
        .stat-input {
            width: 100%;
            padding: 0.25rem 0.2rem; /* Adjusted padding to ensure visibility */
            font-size: 0.875rem; /* text-sm */
            text-align: center;
            background-color: #f9fafb; /* bg-gray-50 */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
        }
        .dark .stat-input {
            background-color: #374151; /* bg-gray-700 */
            border-color: #4b5563; /* border-gray-600 */
            color: #f3f4f6; /* text-gray-100 */
        }
        .stat-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5); /* focus:ring-indigo-500 */
            border-color: #6366f1; /* focus:border-indigo-500 */
        }
        .stat-input[readonly] {
            background-color: #e5e7eb; /* bg-gray-200 */
            cursor: not-allowed;
            color: #4b5563; /* text-gray-600 */
        }
        .dark .stat-input[readonly] {
            background-color: #4b5563; /* bg-gray-600 */
            color: #d1d5db; /* text-gray-300 */
        }
        /* Adjust column widths for better display */
        #player-stats-container table th,
        #player-stats-container table td {
            min-width: 60px; /* Minimum width for input columns */
            white-space: nowrap; /* Prevent text wrapping */
        }
        #player-stats-container table th:first-child,
        #player-stats-container table td:first-child {
            min-width: 100px; /* Wider for stat name */
        }
        /* Make Experience column wider */
        #player-stats-container table th:nth-child(6), /* Targets the new Experience header */
        #player-stats-container table td:nth-child(6) { /* Targets the new Experience cell */
            min-width: 110px; /* Adjusted to be slightly wider for combined Exp/Max Exp */
        }
        /* Ensure inputs within the combined Exp/Max Exp cell are compact */
        .exp-inputs-wrapper input {
            width: calc(50% - 8px); /* Adjust width for two inputs and a separator */
            padding: 0.25rem 0.2rem;
        }

        /* Personal Notes Panel Styles */
        .personal-notes-panel {
            position: fixed;
            top: 50px; /* Initial position from top */
            right: 20px; /* Initial position from right */
            width: 350px; /* Default width */
            min-width: 250px; /* Minimum width */
            min-height: 250px; /* Minimum height */
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            z-index: 100; /* Higher than other content */
            resize: both; /* Allow resizing in both directions */
            overflow: hidden; /* Hide scrollbars if content is smaller than panel */
            border: 1px solid #e2e8f0; /* subtle border */
        }
        .dark .personal-notes-panel {
            background-color: #1f2937; /* Darker gray for dark mode */
            color: #f3f4f6;
            border-color: #374151;
        }

        .personal-notes-header {
            cursor: grab; /* Indicate draggable area */
            user-select: none; /* Prevent text selection during drag */
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        .personal-notes-textarea {
            flex-grow: 1; /* Allow textarea to fill available space */
            min-height: 150px; /* Minimum height for textarea within the panel */
            resize: none; /* Disable default textarea resize, as parent resizes */
            padding: 1rem; /* Padding inside textarea */
            box-sizing: border-box; /* Include padding in width/height */
            border: none; /* Remove textarea border */
            outline: none; /* Remove textarea outline on focus */
            background-color: transparent; /* Make textarea background transparent */
            color: inherit; /* Inherit text color from parent */
            overflow-y: auto; /* Enable vertical scrolling for content */
        }

        /* Table specific styles for inventory sections */
        .inventory-table-container {
            overflow-x: auto;
            margin-bottom: 1rem;
        }
        .inventory-table-container table {
            width: 100%;
            border-collapse: collapse;
        }
        .inventory-table-container th,
        .inventory-table-container td {
            padding: 0.5rem;
            border: 1px solid #e2e8f0; /* border-gray-200 */
            text-align: left;
            font-size: 0.875rem; /* text-sm */
            white-space: nowrap; /* Prevent text wrapping in table cells */
        }
        .dark .inventory-table-container th,
        .dark .inventory-table-container td {
            border-color: #4b5563; /* border-gray-600 */
        }
        .inventory-table-container th {
            background-color: #f1f5f9; /* bg-gray-100 */
            font-weight: 600;
            color: #4a5568; /* text-gray-700 */
        }
        .dark .inventory-table-container th {
            background-color: #374151; /* bg-gray-700 */
            color: #d1d5db; /* text-gray-300 */
        }
        .inventory-table-container td input[type="text"],
        .inventory-table-container td input[type="number"],
        .inventory-table-container td textarea { /* Added textarea */
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            background-color: #fff;
            color: #1a202c;
            box-sizing: border-box; /* Ensure padding doesn't increase total width */
        }
        .dark .inventory-table-container td input[type="text"],
        .dark .inventory-table-container td input[type="number"],
        .dark .inventory-table-container td textarea { /* Added textarea */
            background-color: #1f2937;
            border-color: #4b5563;
            color: #f3f4f6;
        }
        .inventory-table-container td input[type="checkbox"] {
            margin-left: 0.5rem;
        }
        .inventory-table-container td button {
            background-color: #ef4444; /* bg-red-500 */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .inventory-table-container td button:hover {
            background-color: #dc2626; /* bg-red-600 */
        }

        /* Styles for hover-to-zoom effect on Effect textareas */
        .inventory-effect-textarea {
            transition: all 0.2s ease-in-out;
            position: relative; /* Needed for z-index to work correctly */
            z-index: 1; /* Default z-index */
            overflow: hidden; /* Hide scrollbar initially */
            resize: both; /* Allow both vertical and horizontal resizing */
            min-width: 100%; /* Ensure it doesn't shrink below its cell */
        }

        .inventory-effect-textarea:hover,
        .inventory-effect-textarea:focus {
            z-index: 10; /* Bring to front on hover/focus */
            width: 250%; /* Zoom out horizontally */
            height: 200px; /* Increase height for better visibility */
            transform: scale(1.05); /* Slight visual enlargement */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5), 0 5px 15px rgba(0, 0, 0, 0.3); /* Add a subtle shadow */
            overflow: auto; /* Show scrollbar if content overflows on hover/focus */
        }

        /* Specific height adjustments for different effect textareas */
        #weapon-inventory-table .inventory-effect-textarea,
        #armor-inventory-table .inventory-effect-textarea {
            height: 6rem; /* h-24 = 6rem */
        }

        #general-inventory-table .inventory-effect-textarea {
            height: 5rem; /* h-20 = 5rem */
        }

        /* Adjust hover height for general inventory to be slightly smaller */
        #general-inventory-table .inventory-effect-textarea:hover,
        #general-inventory-table .inventory-effect-textarea:focus {
            height: 150px; /* Adjusted hover height for general inventory */
        }

        /* Min-width for Weapon Inventory columns */
        #weapon-inventory-table th:nth-child(1), #weapon-inventory-table td:nth-child(1) { min-width: 120px; } /* Name */
        #weapon-inventory-table th:nth-child(2), #weapon-inventory-table td:nth-child(2) { min-width: 80px; }  /* Type */
        #weapon-inventory-table th:nth-child(3), #weapon-inventory-table td:nth-child(3) { min-width: 90px; }  /* Material */
        #weapon-inventory-table th:nth-child(4), #weapon-inventory-table td:nth-child(4) { min-width: 100px; } /* Requirement */
        #weapon-inventory-table th:nth-child(5), #weapon-inventory-table td:nth-child(5) { min-width: 110px; } /* Required Stat */
        #weapon-inventory-table th:nth-child(6), #weapon-inventory-table td:nth-child(6) { min-width: 80px; }  /* Accuracy */
        #weapon-inventory-table th:nth-child(7), #weapon-inventory-table td:nth-child(7) { min-width: 200px; } /* Damage - increased width for textarea */
        #weapon-inventory-table th:nth-child(8), #weapon-inventory-table td:nth-child(8) { min-width: 200px; } /* Magic Damage - increased width for textarea */
        #weapon-inventory-table th:nth-child(9), #weapon-inventory-table td:nth-child(9) { min-width: 90px; }  /* Magic Type */
        #weapon-inventory-table th:nth-child(10), #weapon-inventory-table td:nth-child(10) { min-width: 200px; } /* Effect */
        #weapon-inventory-table th:nth-child(11), #weapon-inventory-table td:nth-child(11) { min-width: 70px; }  /* Value */
        #weapon-inventory-table th:nth-child(12), #weapon-inventory-table td:nth-child(12) { min-width: 60px; }  /* Use */
        #weapon-inventory-table th:nth-child(13), #weapon-inventory-table td:nth-child(13) { min-width: 80px; }  /* Actions */

        /* Min-width for Armor Inventory columns */
        #armor-inventory-table th:nth-child(1), #armor-inventory-table td:nth-child(1) { min-width: 120px; } /* Name */
        #armor-inventory-table th:nth-child(2), #armor-inventory-table td:nth-child(2) { min-width: 90px; }  /* Location */
        #armor-inventory-table th:nth-child(3), #armor-inventory-table td:nth-child(3) { min-width: 90px; }  /* Material */
        #armor-inventory-table th:nth-child(4), #armor-inventory-table td:nth-child(4) { min-width: 100px; } /* Requirement */
        #armor-inventory-table th:nth-child(5), #armor-inventory-table td:nth-child(5) { min-width: 110px; } /* Required Stat */
        #armor-inventory-table th:nth-child(6), #armor-inventory-table td:nth-child(6) { min-width: 80px; }  /* Defense */
        #armor-inventory-table th:nth-child(7), #armor-inventory-table td:nth-child(7) { min-width: 110px; } /* Magic Defense */
        #armor-inventory-table th:nth-child(8), #armor-inventory-table td:nth-child(8) { min-width: 90px; }  /* Magic Type */
        #armor-inventory-table th:nth-child(9), #armor-inventory-table td:nth-child(9) { min-width: 200px; } /* Effect */
        #armor-inventory-table th:nth-child(10), #armor-inventory-table td:nth-child(10) { min-width: 70px; } /* Value */
        #armor-inventory-table th:nth-child(11), #armor-inventory-table td:nth-child(11) { min-width: 80px; } /* Equipped */
        #armor-inventory-table th:nth-child(12), #armor-inventory-table td:nth-child(12) { min-width: 80px; } /* Actions */

        /* Min-width for General Inventory columns */
        #general-inventory-table th:nth-child(1), #general-inventory-table td:nth-child(1) { min-width: 120px; } /* Name */
        #general-inventory-table th:nth-child(2), #general-inventory-table td:nth-child(2) { min-width: 80px; }  /* Type */
        #general-inventory-table th:nth-child(3), #general-inventory-table td:nth-child(3) { min-width: 200px; } /* Effect */
        #general-inventory-table th:nth-child(4), #general-inventory-table td:nth-child(4) { min-width: 80px; }  /* Accuracy */
        #general-inventory-table th:nth-child(5), #general-inventory-table td:nth-child(5) { min-width: 70px; }  /* Amount */
        #general-inventory-table th:nth-child(6), #general-inventory-table td:nth-child(6) { min-width: 100px; } /* Value (per unit) */
        #general-inventory-table th:nth-child(7), #general-inventory-table td:nth-child(7) { min-width: 80px; }  /* Actions */

        /* Dropdown specific styles */
        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            position: absolute;
            background-color: #f9fafb; /* bg-gray-50 */
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.375rem; /* rounded-md */
            overflow: hidden; /* Ensures rounded corners apply to children */
            right: 0; /* Align dropdown to the right of the button */
            top: 100%; /* Position below the button */
            margin-top: 0.5rem; /* Space between button and dropdown */
        }

        .dark .dropdown-menu {
            background-color: #374151; /* bg-gray-700 */
        }

        .dropdown-menu button {
            color: #1a202c; /* text-gray-900 */
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            width: 100%; /* Make button fill dropdown width */
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dark .dropdown-menu button {
            color: #f3f4f6; /* text-gray-100 */
        }

        .dropdown-menu button:hover {
            background-color: #e5e7eb; /* bg-gray-200 */
        }

        .dark .dropdown-menu button:hover {
            background-color: #4b5563; /* bg-gray-600 */
        }

        /* Status message styling */
        #status-message {
            margin-left: 1rem;
            font-size: 0.9rem;
            color: #6b7280; /* text-gray-500 */
        }
        .dark #status-message {
            color: #9ca3af; /* text-gray-400 */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex flex-col items-center">

    <!-- Sticky Header -->
    <header class="sticky top-0 z-20 w-full bg-indigo-800 dark:bg-indigo-950 shadow-lg py-3 px-4 md:px-8 flex justify-center items-center space-x-4">
        <!-- Save Dropdown -->
        <div class="dropdown-container">
            <button id="save-dropdown-btn"
                    class="px-6 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200 flex items-center">
                Save <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="save-dropdown-menu" class="dropdown-menu hidden">
                <button id="save-current-system-btn">Current System (JSON)</button>
                <button id="save-google-drive-btn">Google Drive</button>
            </div>
        </div>

        <!-- Load Dropdown -->
        <div class="dropdown-container">
            <button id="load-dropdown-btn"
                    class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200 flex items-center">
                Load <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="load-dropdown-menu" class="dropdown-menu hidden">
                <input type="file" id="load-json-input" accept=".json" class="hidden"/>
                <button id="load-current-system-btn">Current System (JSON)</button>
                <button id="load-google-drive-btn">Google Drive</button>
            </div>
        </div>

        <button id="toggle-notes-btn"
                class="px-6 py-2 bg-purple-600 text-white font-semibold rounded-md shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
            Personal Notes
        </button>

        <!-- New Character Selector and Add Button -->
        <div class="flex items-center space-x-2">
            <select id="character-selector"
                    class="px-4 py-2 bg-gray-700 text-white font-semibold rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                <!-- Options will be populated by JS -->
            </select>
            <button id="add-character-btn"
                    class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                Add New Character
            </button>
        </div>

        <!-- Google Drive Auth Status and Button -->
        <div class="flex items-center space-x-2 ml-4">
            <span id="auth-status" class="text-sm text-gray-300">Not Signed In</span>
            <button id="authorize_button" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-md shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200 hidden">
                Sign In
            </button>
            <button id="signout_button" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-md shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200 hidden">
                Sign Out
            </button>
        </div>
        <span id="status-message" class="text-gray-300"></span>
    </header>

    <div class="w-full max-w-4xl bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 mt-6 mb-6">
        <h1 class="text-4xl font-bold text-center mb-6 text-indigo-700 dark:text-indigo-400">
            Character Sheet
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Basic Info</h2>
                <div class="space-y-3">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Character Name</label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                            placeholder="e.g., Elara Whisperwind"
                        />
                    </div>
                    <div>
                        <label for="class-display" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Class</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="class-display"
                                name="class-display"
                                readonly
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 cursor-pointer"
                                placeholder="Select classes..."
                            />
                            <div id="class-dropdown-options" class="absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto">
                                <!-- Options will be dynamically populated here by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <!-- Specialization Section -->
                    <div>
                        <label for="specialization-display" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Specialization</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="specialization-display"
                                name="specialization-display"
                                readonly
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 cursor-pointer"
                                placeholder="Select specializations..."
                            />
                            <div id="specialization-dropdown-options" class="absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto">
                                <!-- Options will be dynamically populated here by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="race" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Race</label>
                        <select
                            id="race"
                            name="race"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 dark:text-gray-100 select-placeholder-text"
                        >
                            <option value="" disabled selected class="defaultOption">Select a Race</option>
                            <option value="Architect">Architect</option>
                            <option value="Demi-humans">Demi-humans</option>
                            <option value="Dimensional">Dimensional</option>
                            <option value="Dragonkin">Dragonkin</option>
                            <option value="Dwarf">Dwarf</option>
                            <option value="Elf">Elf</option>
                            <option value="Gnome">Gnome</option>
                            <option value="Human">Human</option>
                            <option value="Mutant">Mutant</option>
                            <option value="Noki">Noki</option>
                            <option value="Succubus">Succubus</option>
                        </select>
                    </div>
                    <div>
                        <label for="level" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Level</label>
                        <input
                            type="number"
                            id="level"
                            name="level"
                            min="1"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Level Experience</label>
                        <div class="flex items-center mt-1">
                            <input
                                type="number"
                                id="levelExperience"
                                name="levelExperience"
                                min="0"
                                class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                            />
                            <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                            <input
                                type="number"
                                id="levelMaxExperience"
                                name="levelMaxExperience"
                                min="1"
                                class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                                readonly
                            />
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Player Stats</h2>
                    <button id="quick-roll-stats-btn"
                            class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                        Quick Roll Stats
                    </button>
                </div>
                <div id="player-stats-container" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 rounded-lg shadow-md">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-2 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Stat Name</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Value</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Racial</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Equip</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Temp</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Exp</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Player stats rows will be dynamically populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Health & Combat</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Health / Max Health + Max Health Bonus Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Health</label>
                    <div class="flex items-center mt-1">
                        <input
                            type="number"
                            id="hp"
                            name="hp"
                            min="0"
                            class="w-1/3 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                        />
                        <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                        <input
                            type="number"
                            id="maxHp"
                            name="maxHp"
                            min="0"
                            class="w-1/3 px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                            readonly
                        />
                        <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">+</span>
                        <input
                            type="number"
                            id="healthBonus"
                            name="healthBonus"
                            class="w-1/3 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                        />
                    </div>
                </div>
                <!-- Racial Power / Max Racial Power Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Racial Power</label>
                    <div class="flex items-center mt-1">
                        <input
                            type="number"
                            id="racialPower"
                            name="racialPower"
                            min="0"
                            class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                        />
                        <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                        <input
                            type="number"
                            id="maxRacialPower"
                            name="maxRacialPower"
                            min="0"
                            class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                            readonly
                        />
                    </div>
                </div>
                <!-- Magic / Max Magic Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Magic</label>
                    <div class="flex items-center mt-1">
                        <input
                            type="number"
                            id="currentMagicPoints"
                            name="currentMagicPoints"
                            min="0"
                            class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                        />
                        <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                        <input
                            type="number"
                            id="maxMagicPoints"
                            name="maxMagicPoints"
                            min="0"
                            class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                            readonly
                        />
                    </div>
                </div>
                <!-- Total armor + Armor Bonus Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Total armor</label>
                    <div class="flex items-center mt-1">
                        <input
                            type="number"
                            id="ac"
                            name="ac"
                            min="0"
                            class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                            readonly
                        />
                        <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">+</span>
                        <input
                            type="number"
                            id="armorBonus"
                            name="armorBonus"
                            min="0"
                            class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                        />
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Skills</h2>
            <textarea
                id="skills"
                name="skills"
                rows="6"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 resize-y"
                placeholder="e.g., Stealth +5, Perception +4, Acrobatics +3"
            ></textarea>
        </div>

        <!-- Weapon Inventory Section -->
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Weapon Inventory</h2>
                <button id="add-weapon-btn"
                        class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                    Add Weapon
                </button>
            </div>
            <div class="inventory-table-container">
                <table id="weapon-inventory-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 rounded-lg shadow-md">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Material</th>
                            <th>Requirement</th>
                            <th>Required Stat</th>
                            <th>Accuracy</th>
                            <th>Damage</th>
                            <th>Magic Damage</th>
                            <th>Magic Type</th>
                            <th>Effect</th>
                            <th>Value</th>
                            <th>Use</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Weapon rows will be dynamically populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Armor Inventory Section -->
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Armor Inventory</h2>
                <button id="add-armor-btn"
                        class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                    Add Armor
                </button>
            </div>
            <div class="inventory-table-container">
                <table id="armor-inventory-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 rounded-lg shadow-md">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th>Name</th>
                            <th>Location</th>
                            <th>Material</th>
                            <th>Requirement</th>
                            <th>Required Stat</th>
                            <th>Defense</th>
                            <th>Magic Defense</th>
                            <th>Magic Type</th>
                            <th>Effect</th>
                            <th>Value</th>
                            <th>Equipped</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Armor rows will be dynamically populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- General Inventory Section -->
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Inventory</h2>
                <button id="add-general-item-btn"
                        class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                    Add Item
                </button>
            </div>
            <div class="inventory-table-container">
                <table id="general-inventory-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 rounded-lg shadow-md">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Effect</th>
                            <th>Accuracy</th>
                            <th>Amount</th>
                            <th>Value (per unit)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- General item rows will be dynamically populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Personal Notes Panel (Movable and Resizable) -->
    <div id="personal-notes-panel" class="personal-notes-panel hidden">
        <div class="personal-notes-header cursor-grab bg-indigo-700 dark:bg-indigo-900 text-white p-3 rounded-t-lg flex justify-between items-center">
            <h2 class="text-lg font-semibold">Personal Notes</h2>
            <button id="close-notes-panel-btn" class="text-white hover:text-gray-200 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <textarea
            id="personalNotes"
            name="personalNotes"
            class="personal-notes-textarea w-full px-3 py-2 border-t border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
            placeholder="Write your personal notes here..."
        ></textarea>
    </div>

    <script>
        const defaultStatMaxExperience = 7;

        // Function to calculate max experience for a given level
        function calculateLevelMaxExperience(level) {
            return 100;
        }

        // List of available classes for the multi-select dropdown
        const classOptionsList = ["Archer", "Assassin", "Bard", "Berserker", "Brawler", "Knight", "Mage", "Martial artist", "Oracle", "Paladin", "Priest"];

        // Define class specializations
        const classSpecializationsMap = {
            "Mage": ["Chaos", "Dark", "Thunder"],
            "Knight": ["Order"],
            "Martial artist": ["Apprentice", "Warrior", "Master", "Grand Master", "Lord", "King"],
        };

        // Race health multipliers
        const raceHealthMultipliers = {
            "Architect": 0.70,
            "Demi-humans": 1.00,
            "Dimensional": 1.50,
            "Dragonkin": 0.75,
            "Dwarf": 1.20,
            "Elf": 0.80,
            "Gnome": 0.80,
            "Human": 1.00,
            "Mutant": 0.75,
            "Noki": 0.90,
            "Succubus": 0.75,
            "": 1.00 // Default for no race selected
        };

        // Function to calculate max health based on race, level, and bonus
        function calculateMaxHealth(race, level, healthBonus) {
            const multiplier = raceHealthMultipliers[race] || 1.00; // Default to 1 if race not found
            return Math.floor(100 * multiplier * level) + (healthBonus || 0); // Add healthBonus
        }

        // Function to calculate max magic based on level
        function calculateMaxMagic(level) {
            return level * 100;
        }

        // Function to calculate max racial power based on level
        function calculateMaxRacialPower(level) {
            return level * 100;
        }

        // Default character data for creating new characters
        const defaultCharacterData = () => ({
            name: 'Your character name',
            class: [],
            specialization: [],
            race: '',
            level: 1,
            levelExperience: 0,
            levelMaxExperience: calculateLevelMaxExperience(1),
            strength: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            agility: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            magic: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            luck: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            crafting: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            intelligence: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            intimidation: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            charisma: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            negotiation: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            hp: 100,
            maxHp: 100,
            healthBonus: 0,
            currentMagicPoints: 100,
            maxMagicPoints: 100,
            racialPower: 100,
            maxRacialPower: 100,
            ac: 0,
            armorBonus: 0,
            skills: '',
            personalNotes: '',
            // New inventory sections
            weaponInventory: [],
            armorInventory: [],
            generalInventory: [],
        });

        // Array to hold all character sheets
        let characters = [defaultCharacterData()];
        // Index of the currently active character sheet
        let currentCharacterIndex = 0;

        // Getter to easily access the current character
        const character = new Proxy({}, {
            get: function(target, prop) {
                return characters[currentCharacterIndex][prop];
            },
            set: function(target, prop, value) {
                characters[currentCharacterIndex][prop] = value;
                // If the character name changes, update the selector
                if (prop === 'name') {
                    populateCharacterSelector();
                }
                return true;
            }
        });


        // List of player stats for easy iteration
        const playerStatsList = [
            'strength', 'agility', 'magic', 'luck', 'crafting',
            'intelligence', 'intimidation', 'charisma', 'negotiation'
        ];

        // Mapping for common terms to character properties for formula evaluation
        const statMapping = {
        "Strength": "strength-total",
        "Agility": "agility-total",
        "Magic": "magic-total",
        "Luck": "luck-total",
        "Crafting": "crafting-total",
        "Intelligence": "intelligence-total",
        "Intimidation": "intimidation-total",
        "Charisma": "charisma-total",
        "Negotiation": "negotiation-total",
        "HP": "hp",
        "Health": "hp",
        "MaxHP": "maxHp",
        "MaxHealth": "maxHp",
        "MagicPoints": "currentMagicPoints",
        "MaxMagicPoints": "maxMagicPoints",
        "RacialPower": "racialPower",
        "MaxRacialPower": "maxRacialPower",
        "AC": "ac",
        "Armor": "ac"
        };


        // Function to calculate the total for a given stat
        function calculateTotal(statName) {
            const stat = character[statName];
            // Ensure values are treated as numbers, defaulting to 0 if NaN
            const value = parseFloat(stat.value) || 0;
            const racialChange = parseFloat(stat.racialChange) || 0;
            const equipment = parseFloat(stat.equipment) || 0;
            const temporary = parseFloat(stat.temporary) || 0;

            // Calculate total based on the formula: Value + Racial change + Equipment + Temporary
            return value + racialChange + equipment + temporary;
        }

        // Then use a function like this to fetch the actual value from the document
        function getStatValue(statLabel) {
        const elementId = statMapping[statLabel];
        if (!elementId) return '';
        const el = document.getElementById(elementId);
        if (!el) return '';
        return parseFloat(el.value) || 0;
        }

        // Updated calculateFormula to perform regex replace using statMapping
        function calculateFormula(formulaString) {
        if (typeof formulaString !== 'string') return formulaString != null ? formulaString : '';

        // Replace all mapped keys in the formula with actual values from the DOM
        let parsedFormula = formulaString;
        for (const [label, id] of Object.entries(statMapping)) {
            const value = getStatValue(label);
            const regex = new RegExp(`\\b${label}\\b`, 'gi');
            parsedFormula = parsedFormula.replace(regex, value);
        }

        try {
            return eval(parsedFormula); // Note: `eval` can be dangerous; sanitize input if needed
        } catch (error) {
            console.warn(`Error evaluating formula: ${formulaString}`, error);
            return parsedFormula;
        }
        }


        // Function to save all character data to a JSON file (download)
        function saveCharacterToFile() {
            // Create a deep copy of the characters array to modify for saving
            const charactersToSave = JSON.parse(JSON.stringify(characters));

            // Exclude maxExperience and total from each player stat for each character
            charactersToSave.forEach(char => {
                playerStatsList.forEach(statName => {
                    if (char[statName]) {
                        const { maxExperience, total, ...rest } = char[statName];
                        char[statName] = rest; // Assign the object without maxExperience and total
                    }
                });
                // Exclude calculated properties (maxHp, maxMagicPoints, maxRacialPower, ac) from the saved data
                delete char.maxHp;
                delete char.maxMagicPoints;
                delete char.maxRacialPower;
                delete char.ac;
            });

            const dataStr = JSON.stringify(charactersToSave, null, 2); // Pretty print JSON
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `character_sheets.json`; // Save all characters in one file
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showStatusMessage("Character data saved to JSON file!");
            console.log("All character data downloaded as JSON file!");
        }

        // Function to load character data from a JSON file (upload)
        function loadCharacterFromFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (Array.isArray(loadedData)) {
                        characters = loadedData.map(loadedChar => {
                            const newChar = defaultCharacterData(); // Start with a fresh default structure
                            // Deep merge to preserve structure for new/missing sub-properties
                            for (const key in newChar) {
                                if (loadedChar.hasOwnProperty(key)) {
                                    if (key === 'class') {
                                        newChar.class = Array.isArray(loadedChar.class) ? loadedChar.class : [];
                                    } else if (key === 'specialization') {
                                        newChar.specialization = Array.isArray(loadedChar.specialization) ? loadedChar.specialization : [];
                                    } else if (typeof newChar[key] === 'object' && newChar[key] !== null) {
                                        if (typeof loadedChar[key] === 'object' && loadedData[key] !== null) {
                                            newChar[key] = {
                                                ...newChar[key],
                                                ...loadedChar[key]
                                            };
                                            newChar[key].total = calculateTotal(key); // Recalculate total
                                            if (typeof newChar[key].maxExperience === 'undefined' || newChar[key].maxExperience === null) {
                                                newChar[key].maxExperience = defaultStatMaxExperience;
                                            }
                                        } else {
                                            newChar[key] = {
                                                ...newChar[key],
                                                value: parseFloat(loadedChar[key]) || newChar[key].value
                                            };
                                            newChar[key].total = calculateTotal(key);
                                        }
                                    } else {
                                        newChar[key] = loadedData[key];
                                    }
                                }
                            }
                            // Handle new inventory arrays, providing defaults if missing
                            newChar.weaponInventory = loadedChar.weaponInventory || [];
                            newChar.armorInventory = loadedChar.armorInventory || [];
                            newChar.generalInventory = loadedChar.generalInventory || [];

                            // Initialize originalDamage/originalMagicDamage if not present in loaded data
                            newChar.weaponInventory.forEach(weapon => {
                                if (typeof weapon.originalDamage === 'undefined') weapon.originalDamage = weapon.damage;
                                if (typeof weapon.originalMagicDamage === 'undefined') weapon.originalMagicDamage = weapon.magicDamage;
                            });

                            // Recalculate derived properties
                            newChar.maxHp = calculateMaxHealth(newChar.race, newChar.level, newChar.healthBonus);
                            newChar.maxMagicPoints = calculateMaxMagic(newChar.level);
                            newChar.maxRacialPower = calculateMaxRacialPower(newChar.level);
                            newChar.ac = newChar.armorBonus;

                            // Ensure current HP, Magic, and Racial Power don't exceed new max values
                            newChar.hp = Math.min(newChar.hp, newChar.maxHp);
                            newChar.currentMagicPoints = Math.min(newChar.currentMagicPoints, newChar.maxMagicPoints);
                            newChar.racialPower = Math.min(newChar.racialPower, newChar.maxRacialPower);

                            return newChar;
                        });
                        currentCharacterIndex = 0; // Select the first loaded character
                    } else {
                        // If a single character object was loaded (old format), convert it to an array
                        const newChar = defaultCharacterData();
                        for (const key in newChar) {
                            if (loadedData.hasOwnProperty(key)) {
                                if (key === 'class') {
                                    newChar.class = Array.isArray(loadedData.class) ? loadedData.class : [];
                                } else if (key === 'specialization') {
                                    newChar.specialization = Array.isArray(loadedData.specialization) ? loadedData.specialization : [];
                                } else if (typeof newChar[key] === 'object' && newChar[key] !== null) {
                                    if (typeof loadedData[key] === 'object' && loadedData[key] !== null) {
                                        newChar[key] = {
                                            ...newChar[key],
                                            ...loadedData[key]
                                        };
                                        newChar[key].total = calculateTotal(key);
                                        if (typeof newChar[key].maxExperience === 'undefined' || newChar[key].maxExperience === null) {
                                            newChar[key].maxExperience = defaultStatMaxExperience;
                                        }
                                    } else {
                                        newChar[key] = {
                                            ...newChar[key],
                                            value: parseFloat(loadedData[key]) || newChar[key].value
                                        };
                                        newChar[key].total = calculateTotal(key);
                                    }
                                } else {
                                    newChar[key] = loadedData[key];
                                }
                            }
                        }
                        // If loading an old file, initialize new inventory arrays as empty
                        newChar.weaponInventory = loadedData.weaponInventory || [];
                        newChar.armorInventory = loadedData.armorInventory || [];
                        newChar.generalInventory = loadedData.generalInventory || [];

                        // Initialize originalDamage/originalMagicDamage if not present in loaded data
                        newChar.weaponInventory.forEach(weapon => {
                            if (typeof weapon.originalDamage === 'undefined') weapon.originalDamage = weapon.damage;
                            if (typeof weapon.originalMagicDamage === 'undefined') weapon.originalMagicDamage = weapon.magicDamage;
                        });

                        newChar.maxHp = calculateMaxHealth(newChar.race, newChar.level, newChar.healthBonus);
                        newChar.maxMagicPoints = calculateMaxMagic(newChar.level);
                        newChar.maxRacialPower = calculateMaxRacialPower(newChar.level);
                        newChar.ac = newChar.armorBonus;
                        newChar.hp = Math.min(newChar.hp, newChar.maxHp);
                        newChar.currentMagicPoints = Math.min(newChar.currentMagicPoints, newChar.maxMagicPoints);
                        newChar.racialPower = Math.min(newChar.racialPower, newChar.maxRacialPower);

                        characters = [newChar];
                        currentCharacterIndex = 0;
                    }
                    updateDOM(); // Update the UI with loaded data
                    populateCharacterSelector(); // Repopulate the selector
                    showStatusMessage(`Character data loaded from JSON file!`);
                    console.log(`Character data loaded from JSON file!`);
                } catch (e) {
                    showStatusMessage("Error parsing JSON file.", true);
                    console.error("Error parsing JSON file:", e);
                }
            };
            reader.readAsText(file);
        }

        // Function to update the DOM elements with the current character data
        function updateDOM() {
            // Basic Info
            document.getElementById('name').value = character.name;
            document.getElementById('level').value = character.level;
            document.getElementById('levelExperience').value = character.levelExperience;
            document.getElementById('levelMaxExperience').value = character.levelMaxExperience; // This is readonly

            // Handle race selector placeholder color and update max HP
            const raceSelect = document.getElementById('race');
            raceSelect.value = character.race; // Set the selected race
            if (character.race === '') {
                raceSelect.classList.add('select-placeholder-text');
            } else {
                raceSelect.classList.remove('select-placeholder-text');
            }
            // Recalculate maxHp when race is updated in DOM
            character.maxHp = calculateMaxHealth(character.race, character.level, character.healthBonus);
            // Ensure current HP doesn't exceed new max HP when race changes
            character.hp = Math.min(character.hp, character.maxHp);


            // Handle custom multi-select for class
            const classDisplayInput = document.getElementById('class-display');
            const classDropdownOptions = document.getElementById('class-dropdown-options');

            // Set the displayed value for classes
            classDisplayInput.value = character.class.join(', ');

            // Populate and update checkboxes in the dropdown options
            classDropdownOptions.innerHTML = ''; // Clear existing options
            classOptionsList.forEach(className => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md';
                checkboxDiv.innerHTML = `
                    <input
                        type="checkbox"
                        id="class-${className.replace(/\s/g, '-')}"
                        name="class-option"
                        value="${className}"
                        class="form-checkbox h-4 w-4 text-indigo-600 dark:text-indigo-400 rounded border-gray-300 dark:border-gray-600 focus:ring-indigo-500"
                        ${character.class.includes(className) ? 'checked' : ''}
                    />
                    <label for="class-${className.replace(/\s/g, '-')}" class="ml-2 text-sm text-gray-700 dark:text-gray-300 cursor-pointer">${className}</label>
                `;
                classDropdownOptions.appendChild(checkboxDiv);
            });

            // Update Specialization dropdown
            updateSpecializationDropdownAndData();


            // Player Stats
            const playerStatsContainer = document.getElementById('player-stats-container').querySelector('tbody');
            playerStatsContainer.innerHTML = ''; // Clear existing rows

            playerStatsList.forEach(statName => {
                const statData = character[statName];
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700'; // Add hover effect to rows
                row.innerHTML = `
                    <td class="px-2 py-1 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100 capitalize">${statName}</td>
                    <td class="px-2 py-1 whitespace-nowrap">
                        <input type="number" id="${statName}-value" name="${statName}-value" min="0" value="${statData.value}" class="stat-input" />
                    </td>
                    <td class="px-2 py-1 whitespace-nowrap">
                        <input type="number" id="${statName}-racialChange" name="${statName}-racialChange" value="${statData.racialChange}" class="stat-input" />
                    </td>
                    <td class="px-2 py-1 whitespace-nowrap">
                        <input type="number" id="${statName}-equipment" name="${statName}-equipment" value="${statData.equipment}" class="stat-input" />
                    </td>
                    <td class="px-2 py-1 whitespace-nowrap">
                        <input type="number" id="${statName}-temporary" name="${statName}-temporary" value="${statData.temporary}" class="stat-input" />
                    </td>
                    <td class="px-2 py-1 whitespace-nowrap">
                        <div class="flex items-center justify-center exp-inputs-wrapper">
                            <input type="number" id="${statName}-experience" name="${statName}-experience" min="0" value="${statData.experience}" class="stat-input rounded-r-none" />
                            <span class="px-1 py-1 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs">/</span>
                            <input type="number" id="${statName}-maxExperience" name="${statName}-maxExperience" min="1" value="${statData.maxExperience}" readonly class="stat-input rounded-l-none" />
                        </div>
                    </td>
                    <td class="px-2 py-1 whitespace-nowrap">
                        <input type="number" id="${statName}-total" name="${statName}-total" value="${statData.total}" readonly class="stat-input" />
                    </td>
                `;
                playerStatsContainer.appendChild(row);
            });


            // Health & Combat
            document.getElementById('hp').value = character.hp;
            document.getElementById('maxHp').value = character.maxHp; // This now includes healthBonus
            document.getElementById('healthBonus').value = character.healthBonus; // Populate the separate healthBonus input
            document.getElementById('racialPower').value = character.racialPower; // Populate racialPower
            document.getElementById('maxRacialPower').value = character.maxRacialPower; // Populate maxRacialPower
            document.getElementById('currentMagicPoints').value = character.currentMagicPoints; // Populate currentMagicPoints
            document.getElementById('maxMagicPoints').value = character.maxMagicPoints; // Populate maxMagicPoints
            document.getElementById('ac').value = character.ac; // Populate total armor (readonly)
            document.getElementById('armorBonus').value = character.armorBonus; // Populate armor bonus


            // Skills
            document.getElementById('skills').value = character.skills;

            // Render new inventory tables
            renderWeaponInventory();
            renderArmorInventory();
            renderGeneralInventory();
        }

        // Function to render the Weapon Inventory table
        function renderWeaponInventory() {
            const tbody = document.querySelector('#weapon-inventory-table tbody');
            tbody.innerHTML = ''; // Clear existing rows

            character.weaponInventory.forEach((weapon, index) => {
                const row = tbody.insertRow(); // Changed from insertCell() to insertRow()
                // Determine the displayed damage values based on the 'use' checkbox
                const displayDamage = weapon.use ? calculateFormula(weapon.damage) : weapon.damage;
                const displayMagicDamage = weapon.use ? calculateFormula(weapon.magicDamage) : weapon.magicDamage;

                row.innerHTML = `
                    <td><input type="text" data-inventory-type="weapon" data-field="name" data-index="${index}" value="${weapon.name}" class="w-full"></td>
                    <td><input type="text" data-inventory-type="weapon" data-field="type" data-index="${index}" value="${weapon.type}" class="w-full"></td>
                    <td><input type="text" data-inventory-type="weapon" data-field="material" data-index="${index}" value="${weapon.material}" class="w-full"></td>
                    <td><input type="text" data-inventory-type="weapon" data-field="requirement" data-index="${index}" value="${weapon.requirement}" class="w-full"></td>
                    <td><input type="text" data-inventory-type="weapon" data-field="requiredStat" data-index="${index}" value="${weapon.requiredStat}" class="w-full"></td>
                    <td><input type="number" data-inventory-type="weapon" data-field="accuracy" data-index="${index}" value="${weapon.accuracy}" class="w-full"></td>
                    <td><textarea data-inventory-type="weapon" data-field="damage" data-index="${index}" class="w-full inventory-effect-textarea"></textarea></td>
                    <td><textarea data-inventory-type="weapon" data-field="magicDamage" data-index="${index}" class="w-full inventory-effect-textarea"></textarea></td>
                    <td><input type="text" data-inventory-type="weapon" data-field="magicType" data-index="${index}" value="${weapon.magicType}" class="w-full"></td>
                    <td><textarea data-inventory-type="weapon" data-field="effect" data-index="${index}" class="w-full inventory-effect-textarea"></textarea></td>
                    <td><input type="number" data-inventory-type="weapon" data-field="value" data-index="${index}" value="${weapon.value}" class="w-full"></td>
                    <td><input type="checkbox" data-inventory-type="weapon" data-field="use" data-index="${index}" ${weapon.use ? 'checked' : ''}></td>
                    <td><button class="remove-item-btn bg-red-500 hover:bg-red-600" data-inventory-type="weapon" data-index="${index}">Remove</button></td>
                `;
                // Set textarea values after they are in the DOM
                row.querySelector('textarea[data-field="damage"]').value = displayDamage;
                row.querySelector('textarea[data-field="magicDamage"]').value = displayMagicDamage;
                row.querySelector('textarea[data-field="effect"]').value = weapon.effect;
            });
        }

        // Function to render the Armor Inventory table
        function renderArmorInventory() {
            const tbody = document.querySelector('#armor-inventory-table tbody');
            tbody.innerHTML = ''; // Clear existing rows

            character.armorInventory.forEach((armor, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" data-inventory-type="armor" data-field="name" data-index="${index}" value="${armor.name}" class="w-full"></td>
                    <td><input type="text" data-inventory-type="armor" data-field="location" data-index="${index}" value="${armor.location}" class="w-full"></td>
                    <td><input type="text" data-inventory-type="armor" data-field="material" data-index="${index}" value="${armor.material}" class="w-full"></td>
                    <td><input type="text" data-inventory-type="armor" data-field="requirement" data-index="${index}" value="${armor.requirement}" class="w-full"></td>
                    <td><input type="text" data-inventory-type="armor" data-field="requiredStat" data-index="${index}" value="${armor.requiredStat}" class="w-full"></td>
                    <td><input type="number" data-inventory-type="armor" data-field="defense" data-index="${index}" value="${armor.defense}" class="w-full"></td>
                    <td><input type="number" data-inventory-type="armor" data-field="magicDefense" data-index="${index}" value="${armor.magicDefense}" class="w-full"></td>
                    <td><input type="text" data-inventory-type="armor" data-field="magicType" data-index="${index}" value="${armor.magicType}" class="w-full"></td>
                    <td><textarea data-inventory-type="armor" data-field="effect" data-index="${index}" class="w-full inventory-effect-textarea"></textarea></td>
                    <td><input type="number" data-inventory-type="armor" data-field="value" data-index="${index}" value="${armor.value}" class="w-full"></td>
                    <td><input type="checkbox" data-inventory-type="armor" data-field="equipped" data-index="${index}" ${armor.equipped ? 'checked' : ''}></td>
                    <td><button class="remove-item-btn bg-red-500 hover:bg-red-600" data-inventory-type="armor" data-index="${index}">Remove</button></td>
                `;
                // Set textarea value after it's in the DOM
                row.querySelector('textarea[data-field="effect"]').value = armor.effect;
            });
        }

        // Function to render the General Inventory table
        function renderGeneralInventory() {
            const tbody = document.querySelector('#general-inventory-table tbody');
            tbody.innerHTML = ''; // Clear existing rows

            character.generalInventory.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" data-inventory-type="general" data-field="name" data-index="${index}" value="${item.name}" class="w-full"></td>
                    <td><input type="text" data-inventory-type="general" data-field="type" data-index="${index}" value="${item.type}" class="w-full"></td>
                    <td><textarea data-inventory-type="general" data-field="effect" data-index="${index}" class="w-full inventory-effect-textarea"></textarea></td>
                    <td><input type="number" data-inventory-type="general" data-field="accuracy" data-index="${index}" value="${item.accuracy}" class="w-full"></td>
                    <td><input type="number" data-inventory-type="general" data-field="amount" data-index="${index}" value="${item.amount}" class="w-full"></td>
                    <td><input type="number" data-inventory-type="general" data-field="valuePerUnit" data-index="${index}" value="${item.valuePerUnit}" class="w-full"></td>
                    <td><button class="remove-item-btn bg-red-500 hover:bg-red-600" data-inventory-type="general" data-index="${index}">Remove</button></td>
                `;
                // Set textarea value after it's in the DOM
                row.querySelector('textarea[data-field="effect"]').value = item.effect;
            });
        }

        // Function to perform a quick roll for all player stats
        function quickRollStats() {
            playerStatsList.forEach(statName => {
                // Generate a random number between 6 and 20 (inclusive)
                const max = 20;
                const min = 6;
                const rolledValue = Math.floor(Math.random() * (max - min + 1)) + min;
                character[statName].value = rolledValue; // Assign to the 'value' property

                // Recalculate total for the updated stat
                character[statName].total = calculateTotal(statName);

                // Update the DOM for value and total immediately
                document.getElementById(`${statName}-value`).value = character[statName].value;
                document.getElementById(`${statName}-total`).value = character[statName].total;
            });
            // Re-render weapon inventory to update calculated damage values
            renderWeaponInventory();
        }

        // Event listener for all input changes (excluding the custom class multi-select)
        function handleChange(event) {
            const { name, id, value, type, dataset, checked } = event.target;
            let newValue;

            // Check if the input is part of an inventory table
            if (dataset.inventoryType) {
                const inventoryType = dataset.inventoryType;
                const itemIndex = parseInt(dataset.index);
                const field = dataset.field;

                if (inventoryType === 'weapon') {
                    if (field === 'use') { // Handle checkbox for 'use'
                        character.weaponInventory[itemIndex][field] = checked;
                        if (checked) {
                            // Store original values before applying formula
                            character.weaponInventory[itemIndex].originalDamage = character.weaponInventory[itemIndex].damage;
                            character.weaponInventory[itemIndex].originalMagicDamage = character.weaponInventory[itemIndex].magicDamage;
                            // Apply default formulas (can be customized)
                            character.weaponInventory[itemIndex].damage = calculateFormula(character.weaponInventory[itemIndex].damage);
                            character.weaponInventory[itemIndex].magicDamage = calculateFormula(character.weaponInventory[itemIndex].magicDamage);
                        } else {
                            // Restore original values
                            character.weaponInventory[itemIndex].damage = character.weaponInventory[itemIndex].originalDamage;
                            character.weaponInventory[itemIndex].magicDamage = character.weaponInventory[itemIndex].originalMagicDamage;
                        }
                        renderWeaponInventory(); // Re-render to show calculated/restored values
                    } else if (type === 'number' && field !== 'damage' && field !== 'magicDamage') { // Exclude damage/magicDamage from number parsing
                        character.weaponInventory[itemIndex][field] = parseFloat(value) || 0;
                    } else {
                        // For text fields like damage/magicDamage, store the string directly
                        character.weaponInventory[itemIndex][field] = value;
                    }
                } else if (inventoryType === 'armor') {
                    if (field === 'equipped') { // Handle checkbox for 'equipped'
                        character.armorInventory[itemIndex][field] = checked;
                    } else if (type === 'number') {
                        character.armorInventory[itemIndex][field] = parseFloat(value) || 0;
                    } else {
                        character.armorInventory[itemIndex][field] = value;
                    }
                } else if (inventoryType === 'general') {
                    if (type === 'number') {
                        character.generalInventory[itemIndex][field] = parseFloat(value) || 0;
                    } else {
                        character.generalInventory[itemIndex][field] = value;
                    }
                }
                return; // Exit as inventory change is handled
            }

            // This handleChange will now only handle non-class inputs and the race selector
            if (type === 'number') {
                newValue = parseFloat(value) || 0;
            } else {
                newValue = value;
            }

            // Check if the changed input belongs to a player stat
            let isPlayerStatInput = false;
            let statName = '';
            let subProperty = '';

            for (const stat of playerStatsList) {
                if (name.startsWith(`${stat}-`)) {
                    isPlayerStatInput = true;
                    statName = stat;
                    subProperty = name.substring(stat.length + 1); // e.g., 'value', 'racialChange', 'experience', 'maxExperience'
                    break;
                }
            }

            if (isPlayerStatInput) {
                if (subProperty === 'experience') {
                    // Update the experience value directly first
                    character[statName].experience = newValue;

                    // Check if experience has reached or exceeded maxExperience
                    if (character[statName].experience >= character[statName].maxExperience && character[statName].maxExperience > 0) {
                        character[statName].value++; // Increment the stat's value
                        character[statName].experience -= character[statName].maxExperience; // Reset experience
                        // Update the DOM for value and experience immediately
                        document.getElementById(`${statName}-value`).value = character[statName].value;
                        document.getElementById(`${statName}-experience`).value = character[statName].experience;
                    }
                    // Always update the displayed experience, even if it didn't trigger a level up
                    document.getElementById(`${statName}-experience`).value = character[statName].experience;

                } else if (subProperty === 'maxExperience') {
                    // Ensure maxExperience is at least 1
                    character[statName].maxExperience = Math.max(1, newValue);
                    // Update the DOM for maxExperience immediately
                    document.getElementById(`${statName}-maxExperience`).value = character[statName].maxExperience;
                    // Re-evaluate experience if maxExperience changed and current experience is sufficient
                    if (character[statName].experience >= character[statName].maxExperience && character[statName].maxExperience > 0) {
                        character[statName].value++;
                        character[statName].experience -= character[statName].maxExperience;
                        document.getElementById(`${statName}-value`).value = character[statName].value;
                        document.getElementById(`${statName}-experience`).value = character[statName].experience;
                    }

                } else {
                    // For other sub-properties (value, racialChange, equipment, temporary)
                    character[statName][subProperty] = newValue;
                }

                // Recalculate the total for this stat after any change in its sub-properties
                character[statName].total = calculateTotal(statName);
                // Update the total display in the DOM immediately
                document.getElementById(`${statName}-total`).value = character[statName].total;

                // If a stat changes, re-render weapon inventory to update calculated damage values
                renderWeaponInventory();

            } else {
                // For other non-stat inputs (name, level, hp, ac, skills, inventory, race, healthBonus, currentMagicPoints, racialPower, personalNotes)
                // The 'class-display' input is read-only and handled by custom logic, so it's excluded here.
                if (id === 'levelExperience') {
                    character.levelExperience = newValue;
                    if (character.levelExperience >= character.levelMaxExperience) {
                        character.level++;
                        character.levelExperience -= character.levelMaxExperience;
                        character.levelMaxExperience = calculateLevelMaxExperience(character.level);
                        document.getElementById('level').value = character.level;
                        document.getElementById('levelMaxExperience').value = character.levelMaxExperience;
                    }
                    document.getElementById('levelExperience').value = character.levelExperience;
                } else if (id === 'level') {
                    character.level = newValue;
                    character.levelMaxExperience = calculateLevelMaxExperience(character.level);
                    document.getElementById('levelMaxExperience').value = character.levelMaxExperience;
                    // Also update maxHp, maxMagicPoints and maxRacialPower when level changes
                    character.maxHp = calculateMaxHealth(character.race, character.level, character.healthBonus);
                    character.hp = Math.min(character.hp, character.maxHp); // Adjust current HP if it exceeds new max
                    document.getElementById('maxHp').value = character.maxHp;
                    document.getElementById('hp').value = character.hp;

                    character.maxMagicPoints = calculateMaxMagic(character.level);
                    character.currentMagicPoints = Math.min(character.currentMagicPoints, character.maxMagicPoints); // Adjust current Magic if it exceeds new max
                    document.getElementById('maxMagicPoints').value = character.maxMagicPoints;
                    document.getElementById('currentMagicPoints').value = character.currentMagicPoints;

                    character.maxRacialPower = calculateMaxRacialPower(character.level);
                    character.racialPower = Math.min(character.racialPower, character.maxRacialPower); // Adjust current Racial Power if it exceeds new max
                    document.getElementById('maxRacialPower').value = character.maxRacialPower;
                    document.getElementById('racialPower').value = character.racialPower;

                } else if (id === 'race') {
                    character.race = newValue;
                    const raceSelect = document.getElementById('race');
                    if (newValue === '') {
                        raceSelect.classList.add('select-placeholder-text');
                    } else {
                        raceSelect.classList.remove('select-placeholder-text');
                    }
                    // Update maxHp when race changes
                    character.maxHp = calculateMaxHealth(character.race, character.level, character.healthBonus);
                    character.hp = Math.min(character.hp, character.maxHp); // Adjust current HP if it exceeds new max
                    document.getElementById('maxHp').value = character.maxHp;
                    document.getElementById('hp').value = character.hp;
                } else if (id === 'hp') { // Handle current HP input
                    character.hp = Math.min(newValue, character.maxHp); // Ensure current HP doesn't exceed max HP
                    document.getElementById('hp').value = character.hp;
                } else if (id === 'currentMagicPoints') { // Handle current Magic input (renamed)
                    character.currentMagicPoints = Math.min(newValue, character.maxMagicPoints); // Ensure current Magic doesn't exceed max Magic
                    document.getElementById('currentMagicPoints').value = character.currentMagicPoints;
                } else if (id === 'racialPower') { // Handle current Racial Power input
                    character.racialPower = Math.min(newValue, character.maxRacialPower); // Ensure current Racial Power doesn't exceed max Racial Power
                    document.getElementById('racialPower').value = character.racialPower;
                } else if (id === 'healthBonus') { // Handle healthBonus input
                    character.healthBonus = newValue;
                    // Recalculate maxHp when healthBonus changes
                    character.maxHp = calculateMaxHealth(character.race, character.level, character.healthBonus);
                    character.hp = Math.min(character.hp, character.maxHp); // Adjust current HP if it exceeds new max
                    document.getElementById('maxHp').value = character.maxHp;
                    document.getElementById('hp').value = character.hp;
                } else if (id === 'armorBonus') { // Handle armorBonus input
                    character.armorBonus = newValue;
                    character.ac = character.armorBonus; // Update AC based on armorBonus
                    document.getElementById('ac').value = character.ac; // Update readonly AC input
                } else if (id === 'personalNotes') { // Handle personalNotes input
                    character.personalNotes = newValue;
                }
                else if (id !== 'class-display' && id !== 'specialization-display') { // Exclude specialization-display
                    character[name || id] = newValue;
                }
                // If any of these core stats change, re-render weapon inventory to update calculated damage values
                renderWeaponInventory();
            }
            // No saveCharacter here, as it's handled by saveCharacterToFile for explicit save.
        }

        // Function to toggle the visibility of the class dropdown options
        function toggleClassDropdown() {
            const dropdown = document.getElementById('class-dropdown-options');
            dropdown.classList.toggle('hidden');
        }

        // Function to toggle the visibility of the specialization dropdown options
        function toggleSpecializationDropdown() {
            const dropdown = document.getElementById('specialization-dropdown-options');
            dropdown.classList.toggle('hidden');
        }

        // Function to handle changes in the class checkboxes
        function handleClassCheckboxChange(event) {
            const { value, checked } = event.target;

            if (checked) {
                if (!character.class.includes(value)) {
                    character.class.push(value);
                }
            } else {
                character.class = character.class.filter(c => c !== value);
            }
            // Update the displayed value in the input field
            document.getElementById('class-display').value = character.class.join(', ');

            // After class changes, update specialization dropdown
            updateSpecializationDropdownAndData();
            // No saveCharacter here, as it's handled by saveCharacterToFile for explicit save.
        }

        // Function to handle changes in the specialization checkboxes
        function handleSpecializationCheckboxChange(event) {
            const { value, checked } = event.target;

            if (checked) {
                if (!character.specialization.includes(value)) {
                    character.specialization.push(value);
                }
            } else {
                character.specialization = character.specialization.filter(s => s !== value);
            }
            // Update the displayed value in the input field
            document.getElementById('specialization-display').value = character.specialization.join(', ');
            // No saveCharacter here, as it's handled by saveCharacterToFile for explicit save.
        }

        // Function to update the specialization dropdown options and filter selected specializations
        function updateSpecializationDropdownAndData() {
            const specializationDisplayInput = document.getElementById('specialization-display');
            const specializationDropdownOptions = document.getElementById('specialization-dropdown-options');

            // 1. Determine available specializations based on selected classes
            const availableSpecializationsSet = new Set();
            character.class.forEach(selectedClass => {
                if (classSpecializationsMap[selectedClass]) {
                    classSpecializationsMap[selectedClass].forEach(spec => availableSpecializationsSet.add(selectedClass + "" + spec));
                }
            });
            const availableSpecializations = Array.from(availableSpecializationsSet).sort();

            // 2. Filter character.specialization to keep only valid ones
            character.specialization = character.specialization.filter(spec => availableSpecializations.includes(spec));

            // 3. Update the displayed value for specializations
            specializationDisplayInput.value = character.specialization.join(', ');

            // 4. Populate and update checkboxes in the dropdown options
            specializationDropdownOptions.innerHTML = ''; // Clear existing options
            if (availableSpecializations.length === 0) {
                specializationDropdownOptions.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400">No specializations available for selected classes.</div>';
            } else {
                availableSpecializations.forEach(specName => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md';
                    checkboxDiv.innerHTML = `
                        <input
                            type="checkbox"
                            id="specialization-${specName.replace(/\s/g, '-')}"
                            name="specialization-option"
                            value="${specName}"
                            class="form-checkbox h-4 w-4 text-indigo-600 dark:text-indigo-400 rounded border-gray-300 dark:border-gray-600 focus:ring-indigo-500"
                            ${character.specialization.includes(specName) ? 'checked' : ''}
                        />
                        <label for="specialization-${specName.replace(/\s/g, '-')}" class="ml-2 text-sm text-gray-700 dark:text-gray-300 cursor-pointer">${specName}</label>
                    `;
                    specializationDropdownOptions.appendChild(checkboxDiv);
                });
            }
        }

        // Function to toggle the personal notes panel visibility
        function togglePersonalNotesPanel() {
            const notesPanel = document.getElementById('personal-notes-panel');
            const personalNotesTextarea = document.getElementById('personalNotes');

            if (notesPanel.classList.contains('hidden')) {
                // Show panel: populate textarea with current notes
                personalNotesTextarea.value = character.personalNotes;
                notesPanel.classList.remove('hidden');
            } else {
                // Hide panel: save textarea content to character data
                character.personalNotes = personalNotesTextarea.value;
                notesPanel.classList.add('hidden');
            }
        }

        // Draggable functionality for the personal notes panel
        function makeDraggable(element, handle) {
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            handle.addEventListener("mousedown", dragStart);

            function dragStart(e) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === handle || handle.contains(e.target)) {
                    isDragging = true;
                    element.style.cursor = 'grabbing';
                    document.addEventListener("mousemove", drag);
                    document.addEventListener("mouseup", dragEnd);
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault(); // Prevent text selection
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    element.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
                }
            }

            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                element.style.cursor = 'grab';
                document.removeEventListener("mousemove", drag);
                document.removeEventListener("mouseup", dragEnd);
            }
        }

        // Function to populate the character selector dropdown
        function populateCharacterSelector() {
            const selector = document.getElementById('character-selector');
            selector.innerHTML = ''; // Clear existing options

            characters.forEach((charData, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = charData.name || `Character ${index + 1}`;
                selector.appendChild(option);
            });

            selector.value = currentCharacterIndex; // Select the current character
        }

        // Function to switch to a different character
        function switchCharacter(event) {
            currentCharacterIndex = parseInt(event.target.value);
            updateDOM(); // Update the UI with the new character's data
        }

        // Function to add a new character sheet
        function addNewCharacter() {
            const newChar = defaultCharacterData();
            // Give a unique name to the new character
            newChar.name = `Character ${characters.length + 1}`;
            characters.push(newChar);
            currentCharacterIndex = characters.length - 1; // Switch to the new character
            populateCharacterSelector(); // Update the dropdown
            updateDOM(); // Update the UI
            showStatusMessage(`Added new character: ${newChar.name}`);
            console.log(`Added new character: ${newChar.name}`);
        }

        // Functions to add new items to inventories
        function addWeapon() {
            character.weaponInventory.push({ name: '', type: '', material: '', requirement: '', requiredStat: '', accuracy: 100, damage: '', magicDamage: '', magicType: '', effect: '', value: 0, use: false }); // 'use' is now boolean
            renderWeaponInventory();
        }

        function addArmor() {
            character.armorInventory.push({ name: '', location: '', material: '', requirement: '', requiredStat: '', defense: 0, magicDefense: 0, magicType: '', effect: '', value: 0, equipped: false });
            renderArmorInventory();
        }

        function addGeneralItem() {
            character.generalInventory.push({ name: '', type: '', effect: '', accuracy: 0, amount: 0, valuePerUnit: 0 });
            renderGeneralInventory();
        }

        // Function to remove an item from inventory
        function removeItem(event) {
            const inventoryType = event.target.dataset.inventoryType;
            const index = parseInt(event.target.dataset.index);

            if (inventoryType === 'weapon') {
                character.weaponInventory.splice(index, 1);
                renderWeaponInventory();
            } else if (inventoryType === 'armor') {
                character.armorInventory.splice(index, 1);
                renderArmorInventory();
            } else if (inventoryType === 'general') {
                character.generalInventory.splice(index, 1);
                renderGeneralInventory();
            }
        }

        // Function to toggle dropdown visibility
        function toggleDropdown(menuId) {
            document.getElementById(menuId).classList.toggle('hidden');
        }

        // --- Google Drive Integration ---
        // IMPORTANT: Replace with your actual Client ID and API Key from Google Cloud Console
        // Go to Google Cloud Console -> APIs & Services -> Credentials
        // Create OAuth 2.0 Client ID (Web application) and API Key
        // Enable Google Drive API for your project
        const CLIENT_ID = '267631737294-kobdgr3f7uvq4cor0rr8ne9lf9554io6.apps.googleusercontent.com'; // Replace with your Client ID
        const API_KEY = 'AIzaSyDAjAsXXOa_XUlBlgzdyPGxBdcjfTTZYRA'; // Replace with your API Key

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file'; // drive.appdata for hidden app data, drive.file for user-visible files

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        const authStatusSpan = document.getElementById('auth-status');
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const statusMessageElement = document.getElementById('status-message');

        /**
         * Shows a status message to the user.
         * @param {string} message The message to display.
         * @param {boolean} isError Whether the message indicates an error.
         */
        function showStatusMessage(message, isError = false) {
            statusMessageElement.textContent = message;
            statusMessageElement.style.color = isError ? '#ef4444' : '#22c55e'; // red-500 or green-500
            setTimeout(() => {
                statusMessageElement.textContent = '';
            }, 5000); // Clear message after 5 seconds
        }

        /**
         * Callback after api.js is loaded.
         */
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        /**
         * Callback after Google Identity Services are loaded.
         */
        function gisLoaded() {
            // Use initTokenClient for client-side applications to directly get an access token
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse.error !== undefined) {
                        console.error("Token response error:", tokenResponse.error);
                        showStatusMessage("Google Sign-In failed.", true);
                        updateSignInStatus(false);
                        return;
                    }
                    // Set the token for gapi.client to use
                    gapi.client.setToken(tokenResponse);
                    updateSignInStatus(true);
                    showStatusMessage("Signed in to Google Drive.");
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        /**
         * Initializes the Google API client.
         */
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        /**
         * Enables/disables buttons based on API and GIS loading status.
         */
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                authorizeButton.style.display = 'block';
                signoutButton.style.display = 'block';
                // Check initial sign-in status
                updateSignInStatus(gapi.client.getToken() !== null);
            }
        }

        /**
         * Sign in the user upon button click.
         */
        function handleAuthClick() {
            if (tokenClient) {
                // Prompt the user to select a Google account and grant permissions
                tokenClient.requestAccessToken();
            } else {
                showStatusMessage("Google Identity Services not initialized.", true);
            }
        }

        /**
         * Sign out the user upon button click.
         */
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    updateSignInStatus(false);
                    showStatusMessage("Signed out from Google Drive.");
                });
            }
        }

        /**
         * Update UI to reflect sign-in status.
         * @param {boolean} isSignedIn
         */
        function updateSignInStatus(isSignedIn) {
            if (isSignedIn) {
                authStatusSpan.textContent = 'Signed In (Google Drive)';
                authorizeButton.classList.add('hidden');
                signoutButton.classList.remove('hidden');
            } else {
                authStatusSpan.textContent = 'Not Signed In (Google Drive)';
                authorizeButton.classList.remove('hidden');
                signoutButton.classList.add('hidden');
            }
        }

        // Load Google API client and Identity Services
        gapiLoaded();
        gisLoaded(); // Call gisLoaded immediately as per new GSI client library guidelines

        // --- Google Drive File Operations ---
        const DRIVE_FOLDER_NAME = 'CharacterSheetsApp'; // Folder to store character sheets

        /**
         * Saves character data to Google Drive.
         */
        async function saveCharacterToGoogleDrive() {
            if (!gapi.client.getToken()) {
                showStatusMessage("Please sign in to Google Drive first.", true);
                return;
            }

            showStatusMessage("Saving to Google Drive...");

            try {
                const charactersToSave = JSON.parse(JSON.stringify(characters));
                charactersToSave.forEach(char => {
                    playerStatsList.forEach(statName => {
                        if (char[statName]) {
                            const { maxExperience, total, ...rest } = char[statName];
                            char[statName] = rest;
                        }
                    });
                    delete char.maxHp;
                    delete char.maxMagicPoints;
                    delete char.maxRacialPower;
                    delete char.ac;
                });
                const fileContent = JSON.stringify(charactersToSave, null, 2);
                const fileName = 'character_sheets.json';
                const fileMimeType = 'application/json';

                // 1. Check if the folder exists, create if not
                let folderId = null;
                try {
                    const folderResponse = await gapi.client.drive.files.list({
                        q: `name='${DRIVE_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                        spaces: 'drive',
                        fields: 'files(id, name)',
                    });
                    if (folderResponse.result.files.length > 0) {
                        folderId = folderResponse.result.files[0].id;
                    } else {
                        const createFolderResponse = await gapi.client.drive.files.create({
                            name: DRIVE_FOLDER_NAME,
                            mimeType: 'application/vnd.google-apps.folder',
                            fields: 'id',
                        });
                        folderId = createFolderResponse.result.id;
                    }
                } catch (error) {
                    console.error("Error managing Google Drive folder:", error);
                    showStatusMessage("Error accessing Google Drive folder.", true);
                    return;
                }

                // 2. Check if the file already exists in the folder
                let fileId = null;
                try {
                    const fileResponse = await gapi.client.drive.files.list({
                        q: `'${folderId}' in parents and name='${fileName}' and trashed=false`,
                        spaces: 'drive',
                        fields: 'files(id, name)',
                    });
                    if (fileResponse.result.files.length > 0) {
                        fileId = fileResponse.result.files[0].id;
                    }
                } catch (error) {
                    console.error("Error listing Google Drive files:", error);
                    showStatusMessage("Error checking for existing file.", true);
                    return;
                }

                // 3. Create or Update the file
                if (fileId) {
                    // Update existing file
                    const response = await gapi.client.request({
                        path: '/upload/drive/v3/files/' + fileId,
                        method: 'PATCH',
                        params: {
                            uploadType: 'media'
                        },
                        headers: {
                            'Content-Type': fileMimeType
                        },
                        body: fileContent
                    });
                    console.log('File updated:', response.result);
                    showStatusMessage("Character data updated on Google Drive!");
                } else {
                    // Create new file
                    const fileMetadata = {
                        'name': fileName,
                        'mimeType': fileMimeType,
                        'parents': [folderId]
                    };
                    const response = await gapi.client.drive.files.create({
                        resource: fileMetadata,
                        media: {
                            mimeType: fileMimeType,
                            body: fileContent
                        },
                        fields: 'id'
                    });
                    console.log('File created:', response.result);
                    showStatusMessage("Character data saved to Google Drive!");
                }

            } catch (error) {
                console.error('Error saving to Google Drive:', error);
                showStatusMessage("Failed to save to Google Drive. Check console for details.", true);
            }
        }

        /**
         * Loads character data from Google Drive.
         */
        async function loadCharacterFromGoogleDrive() {
            if (!gapi.client.getToken()) {
                showStatusMessage("Please sign in to Google Drive first.", true);
                return;
            }

            showStatusMessage("Loading from Google Drive...");

            try {
                // List files in the specific application folder
                const response = await gapi.client.drive.files.list({
                    q: `name='character_sheets.json' and mimeType='application/json' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                });

                const files = response.result.files;
                if (files.length === 0) {
                    showStatusMessage("No character sheet file found on Google Drive.", true);
                    return;
                }

                // For simplicity, load the first found file.
                // In a real application, you might provide a file picker UI.
                const fileId = files[0].id;

                const fileContentResponse = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });

                const loadedData = JSON.parse(fileContentResponse.body);

                if (Array.isArray(loadedData)) {
                    characters = loadedData.map(loadedChar => {
                        const newChar = defaultCharacterData();
                        for (const key in newChar) {
                            if (loadedChar.hasOwnProperty(key)) {
                                if (key === 'class') {
                                    newChar.class = Array.isArray(loadedChar.class) ? loadedChar.class : [];
                                } else if (key === 'specialization') {
                                    newChar.specialization = Array.isArray(loadedChar.specialization) ? loadedChar.specialization : [];
                                } else if (typeof newChar[key] === 'object' && newChar[key] !== null) {
                                    if (typeof loadedChar[key] === 'object' && loadedChar[key] !== null) {
                                        newChar[key] = {
                                            ...newChar[key],
                                            ...loadedChar[key]
                                        };
                                        newChar[key].total = calculateTotal(key);
                                        if (typeof newChar[key].maxExperience === 'undefined' || newChar[key].maxExperience === null) {
                                            newChar[key].maxExperience = defaultStatMaxExperience;
                                        }
                                    } else {
                                        newChar[key] = {
                                            ...newChar[key],
                                            value: parseFloat(loadedChar[key]) || newChar[key].value
                                        };
                                        newChar[key].total = calculateTotal(key);
                                    }
                                } else {
                                    newChar[key] = loadedChar[key];
                                }
                            }
                        }
                        newChar.weaponInventory = loadedChar.weaponInventory || [];
                        newChar.armorInventory = loadedChar.armorInventory || [];
                        newChar.generalInventory = loadedChar.generalInventory || [];

                        newChar.weaponInventory.forEach(weapon => {
                            if (typeof weapon.originalDamage === 'undefined') weapon.originalDamage = weapon.damage;
                            if (typeof weapon.originalMagicDamage === 'undefined') weapon.originalMagicDamage = weapon.magicDamage;
                        });

                        newChar.maxHp = calculateMaxHealth(newChar.race, newChar.level, newChar.healthBonus);
                        newChar.maxMagicPoints = calculateMaxMagic(newChar.level);
                        newChar.maxRacialPower = calculateMaxRacialPower(newChar.level);
                        newChar.ac = newChar.armorBonus;
                        newChar.hp = Math.min(newChar.hp, newChar.maxHp);
                        newChar.currentMagicPoints = Math.min(newChar.currentMagicPoints, newChar.maxMagicPoints);
                        newChar.racialPower = Math.min(newChar.racialPower, newChar.maxRacialPower);
                        return newChar;
                    });
                    currentCharacterIndex = 0;
                } else {
                    // Handle single character object as before
                    const newChar = defaultCharacterData();
                    for (const key in newChar) {
                        if (loadedData.hasOwnProperty(key)) {
                            if (key === 'class') {
                                newChar.class = Array.isArray(loadedData.class) ? loadedData.class : [];
                            } else if (key === 'specialization') {
                                newChar.specialization = Array.isArray(loadedData.specialization) ? loadedData.specialization : [];
                            } else if (typeof newChar[key] === 'object' && newChar[key] !== null) {
                                if (typeof loadedData[key] === 'object' && loadedData[key] !== null) {
                                    newChar[key] = {
                                        ...newChar[key],
                                        ...loadedData[key]
                                    };
                                    newChar[key].total = calculateTotal(key);
                                    if (typeof newChar[key].maxExperience === 'undefined' || newChar[key].maxExperience === null) {
                                        newChar[key].maxExperience = defaultStatMaxExperience;
                                    }
                                } else {
                                    newChar[key] = {
                                        ...newChar[key],
                                        value: parseFloat(loadedData[key]) || newChar[key].value
                                    };
                                    newChar[key].total = calculateTotal(key);
                                }
                            } else {
                                newChar[key] = loadedData[key];
                            }
                        }
                    }
                    newChar.weaponInventory = loadedData.weaponInventory || [];
                    newChar.armorInventory = loadedData.armorInventory || [];
                    newChar.generalInventory = loadedData.generalInventory || [];

                    newChar.weaponInventory.forEach(weapon => {
                        if (typeof weapon.originalDamage === 'undefined') weapon.originalDamage = weapon.damage;
                        if (typeof weapon.originalMagicDamage === 'undefined') weapon.originalMagicDamage = weapon.magicDamage;
                    });

                    newChar.maxHp = calculateMaxHealth(newChar.race, newChar.level, newChar.healthBonus);
                    newChar.maxMagicPoints = calculateMaxMagic(newChar.level);
                    newChar.maxRacialPower = calculateMaxRacialPower(newChar.level);
                    newChar.ac = newChar.armorBonus;
                    newChar.hp = Math.min(newChar.hp, newChar.maxHp);
                    newChar.currentMagicPoints = Math.min(newChar.currentMagicPoints, newChar.maxMagicPoints);
                    newChar.racialPower = Math.min(newChar.racialPower, newChar.maxRacialPower);

                    characters = [newChar];
                    currentCharacterIndex = 0;
                }
                updateDOM();
                populateCharacterSelector();
                showStatusMessage("Character data loaded from Google Drive!");
                console.log("Character data loaded from Google Drive!");

            } catch (error) {
                console.error('Error loading from Google Drive:', error);
                showStatusMessage("Failed to load from Google Drive. Check console for details.", true);
            }
        }

        // Attach event listeners to all relevant input fields
        function attachEventListeners() {
            // Attach listeners for standard inputs and the race selector
            const inputs = document.querySelectorAll(
                '#name, #level, #levelExperience, #race, #hp, #currentMagicPoints, #racialPower, #skills, #healthBonus, #armorBonus'
            );
            inputs.forEach(input => {
                if (!input.readOnly) {
                    input.addEventListener('input', handleChange);
                }
            });

            // Attach listeners for stat table inputs using delegation
            document.getElementById('player-stats-container').addEventListener('input', function(event) {
                if (event.target.classList.contains('stat-input')) {
                    handleChange(event);
                }
            });


            // Attach event listener for the custom class display input to toggle dropdown
            document.getElementById('class-display').addEventListener('click', toggleClassDropdown);

            // Attach event listeners to the dynamically created class checkboxes (delegation)
            document.getElementById('class-dropdown-options').addEventListener('change', function(event) {
                if (event.target.type === 'checkbox' && event.target.name === 'class-option') {
                    handleClassCheckboxChange(event);
                }
            });

            // Attach event listener for the custom specialization display input to toggle dropdown
            document.getElementById('specialization-display').addEventListener('click', toggleSpecializationDropdown);

            // Attach event listeners to the dynamically created specialization checkboxes (delegation)
            document.getElementById('specialization-dropdown-options').addEventListener('change', function(event) {
                if (event.target.type === 'checkbox' && event.target.name === 'specialization-option') {
                    handleSpecializationCheckboxChange(event);
                }
            });

            // Close dropdowns if clicked outside
            document.addEventListener('click', function(event) {
                const classDisplayInput = document.getElementById('class-display');
                const classDropdownOptions = document.getElementById('class-dropdown-options');
                const specializationDisplayInput = document.getElementById('specialization-display');
                const specializationDropdownOptions = document.getElementById('specialization-dropdown-options');
                const saveDropdownBtn = document.getElementById('save-dropdown-btn');
                const saveDropdownMenu = document.getElementById('save-dropdown-menu');
                const loadDropdownBtn = document.getElementById('load-dropdown-btn');
                const loadDropdownMenu = document.getElementById('load-dropdown-menu');


                if (!classDisplayInput.contains(event.target) && !classDropdownOptions.contains(event.target)) {
                    classDropdownOptions.classList.add('hidden');
                }
                if (!specializationDisplayInput.contains(event.target) && !specializationDropdownOptions.contains(event.target)) {
                    specializationDropdownOptions.classList.add('hidden');
                }
                // Close save dropdown if clicked outside
                if (!saveDropdownBtn.contains(event.target) && !saveDropdownMenu.contains(event.target)) {
                    saveDropdownMenu.classList.add('hidden');
                }
                // Close load dropdown if clicked outside
                if (!loadDropdownBtn.contains(event.target) && !loadDropdownMenu.contains(event.target)) {
                    loadDropdownMenu.classList.add('hidden');
                }
            });


            // Attach event listener for the Quick Roll Stats button
            document.getElementById('quick-roll-stats-btn').addEventListener('click', quickRollStats);

            // Attach event listeners for Save/Load dropdown buttons and options
            document.getElementById('save-dropdown-btn').addEventListener('click', () => toggleDropdown('save-dropdown-menu'));
            document.getElementById('save-current-system-btn').addEventListener('click', saveCharacterToFile);
            document.getElementById('save-google-drive-btn').addEventListener('click', saveCharacterToGoogleDrive);

            document.getElementById('load-dropdown-btn').addEventListener('click', () => toggleDropdown('load-dropdown-menu'));
            document.getElementById('load-current-system-btn').addEventListener('click', () => {
                document.getElementById('load-json-input').click(); // Trigger file input click
            });
            document.getElementById('load-json-input').addEventListener('change', loadCharacterFromFile);
            document.getElementById('load-google-drive-btn').addEventListener('click', loadCharacterFromGoogleDrive);

            // Google Drive Auth buttons
            authorizeButton.addEventListener('click', handleAuthClick);
            signoutButton.addEventListener('click', handleSignoutClick);


            // Attach event listeners for Personal Notes button and panel close button
            document.getElementById('toggle-notes-btn').addEventListener('click', togglePersonalNotesPanel);
            document.getElementById('close-notes-panel-btn').addEventListener('click', togglePersonalNotesPanel); // Changed ID

            // Attach event listeners for character selector and add button
            document.getElementById('character-selector').addEventListener('change', switchCharacter);
            document.getElementById('add-character-btn').addEventListener('click', addNewCharacter);

            // Attach listeners for Add Inventory buttons
            document.getElementById('add-weapon-btn').addEventListener('click', addWeapon);
            document.getElementById('add-armor-btn').addEventListener('click', addArmor);
            document.getElementById('add-general-item-btn').addEventListener('click', addGeneralItem);

            // Attach delegated event listeners for inventory table inputs and remove buttons
            // Use 'input' for text/number fields and 'change' for checkboxes
            document.getElementById('weapon-inventory-table').addEventListener('input', handleChange);
            document.getElementById('armor-inventory-table').addEventListener('input', handleChange);
            document.getElementById('general-inventory-table').addEventListener('input', handleChange);

            document.getElementById('weapon-inventory-table').addEventListener('change', handleChange); // For checkbox 'use'
            document.getElementById('armor-inventory-table').addEventListener('change', handleChange); // For checkbox 'equipped'

            document.getElementById('weapon-inventory-table').addEventListener('click', function(event) {
                if (event.target.classList.contains('remove-item-btn')) {
                    removeItem(event);
                }
            });
            document.getElementById('armor-inventory-table').addEventListener('click', function(event) {
                if (event.target.classList.contains('remove-item-btn')) {
                    removeItem(event);
                }
            });
            document.getElementById('general-inventory-table').addEventListener('click', function(event) {
                if (event.target.classList.contains('remove-item-btn')) {
                    removeItem(event);
                }
            });
        }

        // Initialize the application when the DOM is fully loaded
        window.onload = function() {
            // Initialize maxHp, maxMagicPoints and maxRacialPower based on default race, level, and healthBonus for the first character
            characters[0].maxHp = calculateMaxHealth(characters[0].race, characters[0].level, characters[0].healthBonus);
            characters[0].maxMagicPoints = calculateMaxMagic(characters[0].level);
            characters[0].maxRacialPower = calculateMaxRacialPower(characters[0].level);
            // Initialize AC based on armorBonus for the first character
            characters[0].ac = characters[0].armorBonus;

            populateCharacterSelector(); // Populate the selector on load
            updateDOM();
            attachEventListeners(); // Attach event listeners after DOM is updated

            // Make the personal notes panel draggable
            const personalNotesPanel = document.getElementById('personal-notes-panel');
            const personalNotesHeader = document.querySelector('.personal-notes-header');
            makeDraggable(personalNotesPanel, personalNotesHeader);
        };
    </script>
</body>
