<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #333;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        /* Style for the placeholder-like text in the select element itself */
        .select-placeholder-text {
            color: #9ca3af; /* text-gray-400 */
        }

        .select-placeholder-text:focus {
            color: black; /* text-gray-400 */
        }

        .dark .select-placeholder-text {
            color: #6b7280; /* text-gray-500 */
        }

        .defaultOption {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex flex-col items-center">

    <header class="sticky top-0 z-20 w-full bg-indigo-800 dark:bg-indigo-950 shadow-lg py-3 px-4 md:px-8 flex justify-center">
        <div class="flex space-x-4">
            <button id="save-json-btn"
                    class="px-6 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                Save Character (JSON)
            </button>
            <input type="file" id="load-json-input" accept=".json" class="hidden"/>
            <button id="load-json-btn"
                    class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                Load Character (JSON)
            </button>
        </div>
    </header>

    <div class="w-full max-w-4xl bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 mt-6 mb-6">
        <h1 class="text-4xl font-bold text-center mb-6 text-indigo-700 dark:text-indigo-400">
            Character Sheet
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Basic Info</h2>
                <div class="space-y-3">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Character Name</label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                            placeholder="e.g., Elara Whisperwind"
                        />
                    </div>
                    <div>
                        <label for="class-display" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Class</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="class-display"
                                name="class-display"
                                readonly
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 cursor-pointer"
                                placeholder="Select classes..."
                            />
                            <div id="class-dropdown-options" class="absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto">
                                </div>
                        </div>
                    </div>
                    <div>
                        <label for="race" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Race</label>
                        <select
                            id="race"
                            name="race"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 dark:text-gray-100 select-placeholder-text"
                        >
                            <option value="" disabled selected class="defaultOption">Select a Race</option>
                            <option value="Architect">Architect</option>
                            <option value="Demi-humans">Demi-humans</option>
                            <option value="Dimensional">Dimensional</option>
                            <option value="Dragonkin">Dragonkin</option>
                            <option value="Dwarf">Dwarf</option>
                            <option value="Elf">Elf</option>
                            <option value="Gnome">Gnome</option>
                            <option value="Human">Human</option>
                            <option value="Mutant">Mutant</option>
                            <option value="Noki">Noki</option>
                            <option value="Succubus">Succubus</option>
                        </select>
                    </div>
                    <div>
                        <label for="level" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Level</label>
                        <input
                            type="number"
                            id="level"
                            name="level"
                            min="1"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Level Experience</label>
                        <div class="flex items-center mt-1">
                            <input
                                type="number"
                                id="levelExperience"
                                name="levelExperience"
                                min="0"
                                class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                            />
                            <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                            <input
                                type="number"
                                id="levelMaxExperience"
                                name="levelMaxExperience"
                                min="1"
                                class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                                readonly
                            />
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Player Stats</h2>
                    <button id="quick-roll-stats-btn"
                            class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                        Quick Roll Stats
                    </button>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <div id="player-stats-container"></div>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Health & Combat</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="hp" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Hit Points (HP)</label>
                    <input
                        type="number"
                        id="hp"
                        name="hp"
                        min="0"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                    />
                </div>
                <div>
                    <label for="ac" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Armor Class (AC)</label>
                    <input
                        type="number"
                        id="ac"
                        name="ac"
                        min="0"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                    />
                </div>
            </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Skills</h2>
            <textarea
                id="skills"
                name="skills"
                rows="6"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 resize-y"
                placeholder="e.g., Stealth +5, Perception +4, Acrobatics +3"
            ></textarea>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Inventory</h2>
            <textarea
                id="inventory"
                name="inventory"
                rows="6"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 resize-y"
                placeholder="e.g., Longsword, Leather Armor, 50 Gold Pieces, Potion of Healing"
            ></textarea>
        </div>
    </div>

    <script>
        const defaultStatMaxExperience = 7;

        // Function to calculate max experience for a given level
        function calculateLevelMaxExperience(level) {
            return 100;
        }

        // Initial character data structure with nested objects for player stats
        let character = {
            name: '',
            class: [], // Changed class to an array for multiple selections
            race: '',
            level: 1,
            levelExperience: 0, // Current experience for the character's overall level
            levelMaxExperience: calculateLevelMaxExperience(1), // Max experience to reach the next level
            // Player stats with their sub-components, including experience and maxExperience
            strength: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            agility: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            magic: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            luck: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            crafting: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            intelligence: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            intimidation: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            charisma: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            negotiation: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            hp: 10,
            ac: 10,
            skills: '',
            inventory: '',
        };

        // List of player stats for easy iteration
        const playerStatsList = [
            'strength', 'agility', 'magic', 'luck', 'crafting',
            'intelligence', 'intimidation', 'charisma', 'negotiation'
        ];

        // List of available classes for the multi-select dropdown
        const classOptionsList = ["Archer", "Assassin", "Bard", "Berserker", "Brawler", "Knight", "Mage", "Martial artist", "Oracle", "Paladin", "Priest"];


        // Function to calculate the total for a given stat
        function calculateTotal(statName) {
            const stat = character[statName];
            // Ensure values are treated as numbers, defaulting to 0 if NaN
            const value = parseFloat(stat.value) || 0;
            const racialChange = parseFloat(stat.racialChange) || 0;
            const equipment = parseFloat(stat.equipment) || 0;
            const temporary = parseFloat(stat.temporary) || 0;

            // Calculate total based on the formula: Value + Racial change + Equipment + Temporary
            return value + racialChange + equipment + temporary;
        }

        // Function to save character data to a JSON file (download)
        function saveCharacterToFile() {
            // Create a copy of the character object to modify for saving
            const characterToSave = { ...character };

            // Exclude maxExperience and total from each player stat
            playerStatsList.forEach(statName => {
                if (characterToSave[statName]) {
                    const { maxExperience, total, ...rest } = characterToSave[statName];
                    characterToSave[statName] = rest; // Assign the object without maxExperience and total
                }
            });

            const dataStr = JSON.stringify(characterToSave, null, 2); // Pretty print JSON
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${character.name || 'character'}_sheet.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log("Character data downloaded as JSON file!");
        }

        // Function to load character data from a JSON file (upload)
        function loadCharacterFromFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    // Deep merge to preserve structure for new/missing sub-properties
                    for (const key in character) {
                        if (loadedData.hasOwnProperty(key)) {
                            if (key === 'class') {
                                character.class = Array.isArray(loadedData.class) ? loadedData.class : [];
                            } else if (typeof character[key] === 'object' && character[key] !== null) {
                                if (typeof loadedData[key] === 'object' && loadedData[key] !== null) {
                                    // Merge loaded stat properties, but ensure maxExperience and total are re-calculated or default
                                    character[key] = {
                                        ...character[key], // Start with default sub-properties (like maxExperience)
                                        ...loadedData[key] // Overlay loaded data
                                    };
                                    // Recalculate total for loaded stats (as it's not saved)
                                    character[key].total = calculateTotal(key);
                                    // Ensure maxExperience is set if it was missing from loaded data
                                    if (typeof character[key].maxExperience === 'undefined' || character[key].maxExperience === null) {
                                        character[key].maxExperience = defaultStatMaxExperience; // Default value
                                    }

                                } else {
                                    character[key] = {
                                        ...character[key],
                                        value: parseFloat(loadedData[key]) || character[key].value
                                    };
                                    character[key].total = calculateTotal(key); // Recalculate total
                                }
                            } else {
                                character[key] = loadedData[key];
                            }
                        }
                    }

                    // Handle new level experience properties, providing defaults if missing
                    character.levelExperience = loadedData.levelExperience !== undefined ? loadedData.levelExperience : 0;
                    character.levelMaxExperience = loadedData.levelMaxExperience !== undefined ? loadedData.levelMaxExperience : calculateLevelMaxExperience(character.level);


                    updateDOM(); // Update the UI with loaded data
                    console.log("Character loaded from JSON file!");
                } catch (e) {
                    console.error("Error parsing JSON file:", e);
                    // In a real app, you might show a user-friendly error message here
                }
            };
            reader.readAsText(file);
        }

        // Function to update the DOM elements with the current character data
        function updateDOM() {
            // Basic Info
            document.getElementById('name').value = character.name;
            document.getElementById('level').value = character.level;
            document.getElementById('levelExperience').value = character.levelExperience;
            document.getElementById('levelMaxExperience').value = character.levelMaxExperience; // This is readonly

            // Handle race selector placeholder color
            const raceSelect = document.getElementById('race');
            raceSelect.value = character.race; // Set the selected race
            // Apply or remove the placeholder class based on whether a race is selected
            if (character.race === '') {
                raceSelect.classList.add('select-placeholder-text');
            } else {
                raceSelect.classList.remove('select-placeholder-text');
            }


            // Handle custom multi-select for class
            const classDisplayInput = document.getElementById('class-display');
            const classDropdownOptions = document.getElementById('class-dropdown-options');

            // Set the displayed value for classes
            classDisplayInput.value = character.class.join(', ');

            // Populate and update checkboxes in the dropdown options
            classDropdownOptions.innerHTML = ''; // Clear existing options
            classOptionsList.forEach(className => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md';
                checkboxDiv.innerHTML = `
                    <input
                        type="checkbox"
                        id="class-${className.replace(/\s/g, '-')}"
                        name="class-option"
                        value="${className}"
                        class="form-checkbox h-4 w-4 text-indigo-600 dark:text-indigo-400 rounded border-gray-300 dark:border-gray-600 focus:ring-indigo-500"
                        ${character.class.includes(className) ? 'checked' : ''}
                    />
                    <label for="class-${className.replace(/\s/g, '-')}" class="ml-2 text-sm text-gray-700 dark:text-gray-300 cursor-pointer">${className}</label>
                `;
                classDropdownOptions.appendChild(checkboxDiv);
            });


            // Player Stats
            const playerStatsContainer = document.getElementById('player-stats-container');
            playerStatsContainer.innerHTML = ''; // Clear existing attributes to prevent duplicates

            playerStatsList.forEach(statName => {
                const statData = character[statName];
                const statBlock = document.createElement('div');
                statBlock.className = 'bg-white dark:bg-gray-900 p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700';
                statBlock.innerHTML = `
                    <h3 class="text-xl font-semibold mb-3 text-gray-800 dark:text-gray-200 capitalize">${statName}</h3>
                    <div class="grid grid-cols-6 gap-x-1 gap-y-2 text-center items-end">
                        <div class="text-xs font-semibold text-gray-700 dark:text-gray-300">Value</div>
                        <div class="text-xs font-semibold text-gray-700 dark:text-gray-300">Racial</div>
                        <div class="text-xs font-semibold text-gray-700 dark:text-gray-300">Equip</div>
                        <div class="text-xs font-semibold text-gray-700 dark:text-gray-300">Temp</div>
                        <div class="text-xs font-semibold text-gray-700 dark:text-gray-300">Exp</div>
                        <div class="text-xs font-semibold text-gray-700 dark:text-gray-300">Max Exp</div>

                        <div>
                            <input
                                type="number"
                                id="${statName}-value"
                                name="${statName}-value"
                                min="0"
                                value="${statData.value}"
                                class="mt-1 block w-full px-1 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-center"
                            />
                        </div>
                        <div>
                            <input
                                type="number"
                                id="${statName}-racialChange"
                                name="${statName}-racialChange"
                                value="${statData.racialChange}"
                                class="mt-1 block w-full px-1 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-center"
                            />
                        </div>
                        <div>
                            <input
                                type="number"
                                id="${statName}-equipment"
                                name="${statName}-equipment"
                                value="${statData.equipment}"
                                class="mt-1 block w-full px-1 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-center"
                            />
                        </div>
                        <div>
                            <input
                                type="number"
                                id="${statName}-temporary"
                                name="${statName}-temporary"
                                value="${statData.temporary}"
                                class="mt-1 block w-full px-1 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-center"
                            />
                        </div>
                        <div>
                            <input
                                type="number"
                                id="${statName}-experience"
                                name="${statName}-experience"
                                value="${statData.experience}"
                                min="0"
                                class="mt-1 block w-full px-1 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-center"
                            />
                        </div>
                        <div>
                            <input
                                type="number"
                                id="${statName}-maxExperience"
                                name="${statName}-maxExperience"
                                value="${statData.maxExperience}"
                                min="1"
                                class="mt-1 block w-full px-1 py-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-center"
                            />
                        </div>
                        <div class="col-span-6 mt-2">
                            <label for="${statName}-total" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Total</label>
                            <input
                                type="number"
                                id="${statName}-total"
                                name="${statName}-total"
                                value="${statData.total}"
                                readonly
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                            />
                        </div>
                    </div>
                `;
                playerStatsContainer.appendChild(statBlock);
            });


            // Health & Combat
            document.getElementById('hp').value = character.hp;
            document.getElementById('ac').value = character.ac;

            // Skills & Inventory
            document.getElementById('skills').value = character.skills;
            document.getElementById('inventory').value = character.inventory;
        }

        // Function to perform a quick roll for all player stats
        function quickRollStats() {
            playerStatsList.forEach(statName => {
                // Generate a random number between 6 and 20 (inclusive)
                const max = 20;
                const min = 6;
                const rolledValue = Math.floor(Math.random() * (max - min + 1)) + min;
                character[statName].value = rolledValue; // Assign to the 'value' property

                // Recalculate total for the updated stat
                character[statName].total = calculateTotal(statName);

                // Update the DOM for value and total immediately
                document.getElementById(`${statName}-value`).value = character[statName].value;
                document.getElementById(`${statName}-total`).value = character[statName].total;
            });
            // No saveCharacter here, as it's handled by handleChange for individual inputs
            // or by the saveCharacterToFile for explicit save.
        }

        // Event listener for all input changes (excluding the custom class multi-select)
        function handleChange(event) {
            const { name, id, value, type } = event.target;
            let newValue;

            // This handleChange will now only handle non-class inputs and the race selector
            if (type === 'number') {
                newValue = parseFloat(value) || 0;
            } else {
                newValue = value;
            }

            // Check if the changed input belongs to a player stat
            let isPlayerStatInput = false;
            let statName = '';
            let subProperty = '';

            for (const stat of playerStatsList) {
                if (name.startsWith(`${stat}-`)) {
                    isPlayerStatInput = true;
                    statName = stat;
                    subProperty = name.substring(stat.length + 1); // e.g., 'value', 'racialChange', 'experience', 'maxExperience'
                    break;
                }
            }

            if (isPlayerStatInput) {
                if (subProperty === 'experience') {
                    // Update the experience value directly first
                    character[statName].experience = newValue;

                    // Check if experience has reached or exceeded maxExperience
                    if (character[statName].experience >= character[statName].maxExperience && character[statName].maxExperience > 0) {
                        character[statName].value++; // Increment the stat's value
                        character[statName].experience -= character[statName].maxExperience; // Reset experience
                        // Update the DOM for value and experience immediately
                        document.getElementById(`${statName}-value`).value = character[statName].value;
                        document.getElementById(`${statName}-experience`).value = character[statName].experience;
                    }
                    // Always update the displayed experience, even if it didn't trigger a level up
                    document.getElementById(`${statName}-experience`).value = character[statName].experience;

                } else if (subProperty === 'maxExperience') {
                    // Ensure maxExperience is at least 1
                    character[statName].maxExperience = Math.max(1, newValue);
                    // Update the DOM for maxExperience immediately
                    document.getElementById(`${statName}-maxExperience`).value = character[statName].maxExperience;
                    // Re-evaluate experience if maxExperience changed and current experience is sufficient
                    if (character[statName].experience >= character[statName].maxExperience && character[statName].maxExperience > 0) {
                        character[statName].value++;
                        character[statName].experience -= character[statName].maxExperience;
                        document.getElementById(`${statName}-value`).value = character[statName].value;
                        document.getElementById(`${statName}-experience`).value = character[statName].experience;
                    }

                } else {
                    // For other sub-properties (value, racialChange, equipment, temporary)
                    character[statName][subProperty] = newValue;
                }

                // Recalculate the total for this stat after any change in its sub-properties
                character[statName].total = calculateTotal(statName);
                // Update the total display in the DOM immediately
                document.getElementById(`${statName}-total`).value = character[statName].total;

            } else {
                // For other non-stat inputs (name, level, hp, ac, skills, inventory, race)
                // The 'class-display' input is read-only and handled by custom logic, so it's excluded here.
                if (id === 'levelExperience') {
                    character.levelExperience = newValue;
                    if (character.levelExperience >= character.levelMaxExperience) {
                        character.level++;
                        character.levelExperience -= character.levelMaxExperience;
                        character.levelMaxExperience = calculateLevelMaxExperience(character.level);
                        document.getElementById('level').value = character.level;
                        document.getElementById('levelMaxExperience').value = character.levelMaxExperience;
                    }
                    document.getElementById('levelExperience').value = character.levelExperience;
                } else if (id !== 'class-display') {
                    character[name || id] = newValue;

                    // Apply/remove placeholder class for race selector
                    if (id === 'race') {
                        const raceSelect = document.getElementById('race');
                        if (newValue === '') {
                            raceSelect.classList.add('select-placeholder-text');
                        } else {
                            raceSelect.classList.remove('select-placeholder-text');
                        }
                    }
                }
            }
            // No saveCharacter here, as it's handled by saveCharacterToFile for explicit save.
        }

        // Function to toggle the visibility of the class dropdown options
        function toggleClassDropdown() {
            const dropdown = document.getElementById('class-dropdown-options');
            dropdown.classList.toggle('hidden');
        }

        // Function to handle changes in the class checkboxes
        function handleClassCheckboxChange(event) {
            const { value, checked } = event.target;

            if (checked) {
                if (!character.class.includes(value)) {
                    character.class.push(value);
                }
            } else {
                character.class = character.class.filter(c => c !== value);
            }
            // Update the displayed value in the input field
            document.getElementById('class-display').value = character.class.join(', ');
            // No saveCharacter here, as it's handled by saveCharacterToFile for explicit save.
        }

        // Attach event listeners to all relevant input fields
        function attachEventListeners() {
            // Attach listeners for standard inputs and the race selector
            const inputs = document.querySelectorAll('input[type="text"]:not(#class-display), input[type="number"], textarea, select');
            inputs.forEach(input => {
                if (!input.readOnly) {
                    input.addEventListener('input', handleChange);
                }
            });

            // Attach event listener for the custom class display input to toggle dropdown
            document.getElementById('class-display').addEventListener('click', toggleClassDropdown);

            // Attach event listeners to the dynamically created class checkboxes (delegation)
            document.getElementById('class-dropdown-options').addEventListener('change', function(event) {
                if (event.target.type === 'checkbox' && event.target.name === 'class-option') {
                    handleClassCheckboxChange(event);
                }
            });

            // Close the dropdown if clicked outside
            document.addEventListener('click', function(event) {
                const classDisplayInput = document.getElementById('class-display');
                const classDropdownOptions = document.getElementById('class-dropdown-options');
                if (!classDisplayInput.contains(event.target) && !classDropdownOptions.contains(event.target)) {
                    classDropdownOptions.classList.add('hidden');
                }
            });

            // Attach event listener for the Quick Roll Stats button
            document.getElementById('quick-roll-stats-btn').addEventListener('click', quickRollStats);

            // Attach event listeners for Save/Load JSON buttons
            document.getElementById('save-json-btn').addEventListener('click', saveCharacterToFile);
            document.getElementById('load-json-btn').addEventListener('click', () => {
                document.getElementById('load-json-input').click(); // Trigger file input click
            });
            document.getElementById('load-json-input').addEventListener('change', loadCharacterFromFile);
        }

        // Initialize the application when the DOM is fully loaded
        window.onload = function() {
            // When loading from a file, we don't have initial data, so we just update the DOM
            // to reflect the default empty state, then wait for user to load a file.
            updateDOM();
            attachEventListeners(); // Attach event listeners after DOM is updated
        };
    </script>
</body>
</html>
