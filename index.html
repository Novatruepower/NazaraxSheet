// HTML Boilerplate (put inside your HTML file):
// <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
// <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
// <button id="authorize_button" onclick="handleAuthClick()" disabled>Authorize</button>
// <button id="signout_button" onclick="handleSignoutClick()" disabled>Sign Out</button>
// <ul id="file_list"></ul>
// <textarea id="editor" style="width:100%; height:300px;"></textarea>
// <button id="save_button">Save</button>

<head>
  <meta charset="UTF-8">
  <title>Google Drive File Editor</title>
  <style>
    #editor {
      width: 100%;
      height: 300px;
    }
    #file_list li {
      cursor: pointer;
      padding: 5px;
    }
    #file_list li:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1>Google Drive File Editor</h1>
  <button id="authorize_button" disabled>Authorize</button>
  <button id="signout_button" disabled>Sign Out</button>

  <h2>Select a File</h2>
  <ul id="file_list"></ul>

  <h2>Edit File</h2>
  <textarea id="editor" placeholder="Select a file to load content..."></textarea><br>
  <button id="save_button">Save</button>

  <!-- Google API Scripts -->
  <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
  <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>

  <script>
    const CLIENT_ID = '527331500399-1kmgdnjjlbkv7jtkmrsqh1mlbga6fomf.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyBLG6Y30t5fZ-jWSeRbR0tWKgqCN4cjTGg';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '',
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        document.getElementById('authorize_button').disabled = false;
      }
    }

    document.getElementById('authorize_button').onclick = () => {
      tokenClient.callback = async (resp) => {
        if (resp.error) throw resp;
        document.getElementById('signout_button').disabled = false;
        listFiles();
      };
      tokenClient.requestAccessToken({ prompt: 'consent' });
    };

    document.getElementById('signout_button').onclick = () => {
      const token = gapi.client.getToken();
      if (token) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('file_list').innerHTML = '';
        document.getElementById('editor').value = '';
        alert('Signed out.');
      }
    };

    async function listFiles() {
      const res = await gapi.client.drive.files.list({
        pageSize: 10,
        fields: 'files(id, name)'
      });

      const files = res.result.files;
      const list = document.getElementById('file_list');
      list.innerHTML = '';

      if (!files || files.length === 0) {
        list.textContent = 'No files found.';
        return;
      }

      files.forEach(file => {
        const li = document.createElement('li');
        li.textContent = file.name;
        li.onclick = () => loadFile(file.id);
        list.appendChild(li);
      });
    }

    async function loadFile(fileId) {
      const res = await gapi.client.drive.files.get({ fileId, alt: 'media' });
      const editor = document.getElementById('editor');
      editor.value = res.body;

      document.getElementById('save_button').onclick = async () => {
        await gapi.client.request({
          path: `/upload/drive/v3/files/${fileId}`,
          method: 'PATCH',
          params: {
            uploadType: 'media'
          },
          body: editor.value
        });
        alert('File saved!');
      };
    }
  </script>
</body>
