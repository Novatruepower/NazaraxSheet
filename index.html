<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Sheet</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #333;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        /* Style for the placeholder-like text in the select element itself */
        .select-placeholder-text {
            color: #9ca3af; /* text-gray-400 */
        }

        .select-placeholder-text:focus {
            color: black; /* text-gray-400 */
        }

        .defaultOption {
            display: none;
        }
        /* Specific styling for table inputs to make them compact */
        .stat-input {
            width: 100%;
            padding: 0.25rem 0.2rem; /* Adjusted padding to ensure visibility */
            font-size: 0.875rem; /* text-sm */
            text-align: center;
            background-color: #f9fafb; /* bg-gray-50 */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
        }
        .dark .stat-input {
            background-color: #374151; /* bg-gray-700 */
            border-color: #4b5563; /* border-gray-600 */
            color: #f3f4f6; /* text-gray-100 */
        }
        .stat-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5); /* focus:ring-indigo-500 */
            border-color: #6366f1; /* focus:border-indigo-500 */
        }
        .stat-input[readonly] {
            background-color: #e5e7eb; /* bg-gray-200 */
            cursor: not-allowed;
            color: #4b5563; /* text-gray-600 */
        }
        .dark .stat-input[readonly] {
            background-color: #4b5563; /* bg-gray-600 */
            color: #d1d5db; /* text-gray-300 */
        }
        /* Adjust column widths for better display */
        #player-stats-container table th,
        #player-stats-container table td {
            min-width: 60px; /* Minimum width for input columns */
            white-space: nowrap; /* Prevent text wrapping */
        }
        #player-stats-container table th:first-child,
        #player-stats-container table td:first-child {
            min-width: 100px; /* Wider for stat name */
        }
        /* Make Experience column narrower */
        #player-stats-container table th:nth-child(6), /* Targets the new Experience header */
        #player-stats-container table td:nth-child(6) { /* Targets the new Experience cell */
            min-width: 90px; /* Adjusted to be smaller for combined Exp/Max Exp */
        }
        /* Ensure inputs within the combined Exp/Max Exp cell are compact */
        .exp-inputs-wrapper input {
            width: calc(50% - 8px); /* Adjust width for two inputs and a separator */
            padding: 0.25rem 0.2rem;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; /* Higher than header */
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            max-height: 80vh; /* Limit height for scrollability */
            display: flex;
            flex-direction: column;
        }
        .dark .modal-content {
            background-color: #1f2937; /* Darker gray for dark mode */
            color: #f3f4f6;
        }
        .modal-textarea {
            flex-grow: 1; /* Allow textarea to fill available space */
            min-height: 200px; /* Minimum height for textarea */
            resize: vertical; /* Allow vertical resizing */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex flex-col items-center">

    <!-- Sticky Header -->
    <header class="sticky top-0 z-20 w-full bg-indigo-800 dark:bg-indigo-950 shadow-lg py-3 px-4 md:px-8 flex justify-center">
        <div class="flex space-x-4">
            <button id="save-json-btn"
                    class="px-6 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                Save Character (JSON)
            </button>
            <input type="file" id="load-json-input" accept=".json" class="hidden"/>
            <button id="load-json-btn"
                    class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                Load Character (JSON)
            </button>
            <button id="toggle-notes-btn"
                    class="px-6 py-2 bg-purple-600 text-white font-semibold rounded-md shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                Personal Notes
            </button>
        </div>
    </header>

    <div class="w-full max-w-4xl bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 mt-6 mb-6">
        <h1 class="text-4xl font-bold text-center mb-6 text-indigo-700 dark:text-indigo-400">
            Character Sheet
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Basic Info</h2>
                <div class="space-y-3">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Character Name</label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                            placeholder="e.g., Elara Whisperwind"
                        />
                    </div>
                    <div>
                        <label for="class-display" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Class</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="class-display"
                                name="class-display"
                                readonly
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 cursor-pointer"
                                placeholder="Select classes..."
                            />
                            <div id="class-dropdown-options" class="absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto">
                                <!-- Options will be dynamically populated here by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <!-- Specialization Section -->
                    <div>
                        <label for="specialization-display" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Specialization</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="specialization-display"
                                name="specialization-display"
                                readonly
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 cursor-pointer"
                                placeholder="Select specializations..."
                            />
                            <div id="specialization-dropdown-options" class="absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto">
                                <!-- Options will be dynamically populated here by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="race" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Race</label>
                        <select
                            id="race"
                            name="race"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 dark:text-gray-100 select-placeholder-text"
                        >
                            <option value="" disabled selected class="defaultOption">Select a Race</option>
                            <option value="Architect">Architect</option>
                            <option value="Demi-humans">Demi-humans</option>
                            <option value="Dimensional">Dimensional</option>
                            <option value="Dragonkin">Dragonkin</option>
                            <option value="Dwarf">Dwarf</option>
                            <option value="Elf">Elf</option>
                            <option value="Gnome">Gnome</option>
                            <option value="Human">Human</option>
                            <option value="Mutant">Mutant</option>
                            <option value="Noki">Noki</option>
                            <option value="Succubus">Succubus</option>
                        </select>
                    </div>
                    <div>
                        <label for="level" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Level</label>
                        <input
                            type="number"
                            id="level"
                            name="level"
                            min="1"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Level Experience</label>
                        <div class="flex items-center mt-1">
                            <input
                                type="number"
                                id="levelExperience"
                                name="levelExperience"
                                min="0"
                                class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                            />
                            <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                            <input
                                type="number"
                                id="levelMaxExperience"
                                name="levelMaxExperience"
                                min="1"
                                class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                                readonly
                            />
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Player Stats</h2>
                    <button id="quick-roll-stats-btn"
                            class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                        Quick Roll Stats
                    </button>
                </div>
                <div id="player-stats-container" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 rounded-lg shadow-md">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-2 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Stat Name</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Value</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Racial</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Equip</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Temp</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Exp</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Max Exp</th>
                                <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Player stats rows will be dynamically populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Health & Combat</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Health / Max Health + Max Health Bonus Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Health</label>
                    <div class="flex items-center mt-1">
                        <input
                            type="number"
                            id="hp"
                            name="hp"
                            min="0"
                            class="w-1/3 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                        />
                        <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                        <input
                            type="number"
                            id="maxHp"
                            name="maxHp"
                            min="0"
                            class="w-1/3 px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                            readonly
                        />
                        <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">+</span>
                        <input
                            type="number"
                            id="healthBonus"
                            name="healthBonus"
                            class="w-1/3 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                        />
                    </div>
                </div>
                <!-- Racial Power / Max Racial Power Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Racial Power</label>
                    <div class="flex items-center mt-1">
                        <input
                            type="number"
                            id="racialPower"
                            name="racialPower"
                            min="0"
                            class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                        />
                        <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                        <input
                            type="number"
                            id="maxRacialPower"
                            name="maxRacialPower"
                            min="0"
                            class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                            readonly
                        />
                    </div>
                </div>
                <!-- Magic / Max Magic Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Magic</label>
                    <div class="flex items-center mt-1">
                        <input
                            type="number"
                            id="currentMagicPoints"
                            name="currentMagicPoints"
                            min="0"
                            class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                        />
                        <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                        <input
                            type="number"
                            id="maxMagicPoints"
                            name="maxMagicPoints"
                            min="0"
                            class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                            readonly
                        />
                    </div>
                </div>
                <!-- Total armor + Armor Bonus Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Total armor</label>
                    <div class="flex items-center mt-1">
                        <input
                            type="number"
                            id="ac"
                            name="ac"
                            min="0"
                            class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                            readonly
                        />
                        <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">+</span>
                        <input
                            type="number"
                            id="armorBonus"
                            name="armorBonus"
                            min="0"
                            class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                        />
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Skills</h2>
            <textarea
                id="skills"
                name="skills"
                rows="6"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 resize-y"
                placeholder="e.g., Stealth +5, Perception +4, Acrobatics +3"
            ></textarea>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Inventory</h2>
            <textarea
                id="inventory"
                name="inventory"
                rows="6"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 resize-y"
                placeholder="e.g., Longsword, Leather Armor, 50 Gold Pieces, Potion of Healing"
            ></textarea>
        </div>
    </div>

    <!-- Personal Notes Modal -->
    <div id="notes-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Personal Notes</h2>
            <textarea
                id="personalNotes"
                name="personalNotes"
                rows="15"
                class="modal-textarea mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                placeholder="Write your personal notes here..."
            ></textarea>
            <button id="close-notes-modal-btn"
                    class="mt-4 px-6 py-2 bg-red-600 text-white font-semibold rounded-md shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                Close
            </button>
        </div>
    </div>

    <script>
        const defaultStatMaxExperience = 7;

        // Function to calculate max experience for a given level
        function calculateLevelMaxExperience(level) {
            return 100;
        }

        // Race health multipliers
        const raceHealthMultipliers = {
            "Architect": 0.70,
            "Demi-humans": 1.00,
            "Dimensional": 1.50,
            "Dragonkin": 0.75,
            "Dwarf": 1.20,
            "Elf": 0.80,
            "Gnome": 0.80,
            "Human": 1.00,
            "Mutant": 0.75,
            "Noki": 0.90,
            "Succubus": 0.75,
            "": 1.00 // Default for no race selected
        };

        // Function to calculate max health based on race, level, and bonus
        function calculateMaxHealth(race, level, healthBonus) {
            const multiplier = raceHealthMultipliers[race] || 1.00; // Default to 1 if race not found
            return Math.floor(100 * multiplier * level) + (healthBonus || 0); // Add healthBonus
        }

        // Function to calculate max magic based on level
        function calculateMaxMagic(level) {
            return level * 100;
        }

        // Function to calculate max racial power based on level
        function calculateMaxRacialPower(level) {
            return level * 100;
        }

        // Define class specializations
        const classSpecializationsMap = {
            "Mage": ["Chaos", "Dark", "Thunder"],
            "Knight": ["Order"],
            "Martial artist": ["Apprentice", "Warrior", "Master", "Grand Master", "Lord", "King"],
        };

        // Initial character data structure with nested objects for player stats
        let character = {
            name: '',
            class: [], // Changed class to an array for multiple selections
            specialization: [], // New property for specializations
            race: '',
            level: 1,
            levelExperience: 0, // Current experience for the character's overall level
            levelMaxExperience: calculateLevelMaxExperience(1), // Max experience to reach the next level
            // Player stats with their sub-components, including experience and maxExperience
            strength: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            agility: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            magic: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 }, // This is the player stat 'magic'
            luck: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            crafting: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            intelligence: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            intimidation: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            charisma: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            negotiation: { value: 10, racialChange: 0, equipment: 0, temporary: 0, experience: 0, maxExperience: defaultStatMaxExperience, total: 10 },
            hp: 100, // Current health
            maxHp: 100, // Calculated max health (will include healthBonus)
            healthBonus: 0, // New property for additional max health
            currentMagicPoints: 100, // Current magic points (renamed from 'magic')
            maxMagicPoints: 100, // Calculated max magic points (renamed from 'maxMagic')
            racialPower: 100, // Current racial power points
            maxRacialPower: 100, // Calculated max racial power points
            ac: 0, // Total armor
            armorBonus: 0, // New property for armor bonus
            skills: '',
            inventory: '',
            personalNotes: '', // New property for personal notes
        };

        // List of player stats for easy iteration
        const playerStatsList = [
            'strength', 'agility', 'magic', 'luck', 'crafting',
            'intelligence', 'intimidation', 'charisma', 'negotiation'
        ];

        // List of available classes for the multi-select dropdown
        const classOptionsList = ["Archer", "Assassin", "Bard", "Berserker", "Brawler", "Knight", "Mage", "Martial artist", "Oracle", "Paladin", "Priest"];


        // Function to calculate the total for a given stat
        function calculateTotal(statName) {
            const stat = character[statName];
            // Ensure values are treated as numbers, defaulting to 0 if NaN
            const value = parseFloat(stat.value) || 0;
            const racialChange = parseFloat(stat.racialChange) || 0;
            const equipment = parseFloat(stat.equipment) || 0;
            const temporary = parseFloat(stat.temporary) || 0;

            // Calculate total based on the formula: Value + Racial change + Equipment + Temporary
            return value + racialChange + equipment + temporary;
        }

        // Function to save character data to a JSON file (download)
        function saveCharacterToFile() {
            // Create a copy of the character object to modify for saving
            const characterToSave = { ...character };

            // Exclude maxExperience and total from each player stat
            playerStatsList.forEach(statName => {
                if (characterToSave[statName]) {
                    const { maxExperience, total, ...rest } = characterToSave[statName];
                    characterToSave[statName] = rest; // Assign the object without maxExperience and total
                }
            });

            // Exclude calculated properties (maxHp, maxMagicPoints, maxRacialPower, ac) from the saved data
            const { maxHp, maxMagicPoints, maxRacialPower, ac, ...finalCharacterToSave } = characterToSave;

            const dataStr = JSON.stringify(finalCharacterToSave, null, 2); // Pretty print JSON
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${character.name || 'character'}_sheet.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log("Character data downloaded as JSON file!");
        }

        // Function to load character data from a JSON file (upload)
        function loadCharacterFromFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    // Deep merge to preserve structure for new/missing sub-properties
                    for (const key in character) {
                        if (loadedData.hasOwnProperty(key)) {
                            if (key === 'class') {
                                character.class = Array.isArray(loadedData.class) ? loadedData.class : [];
                            } else if (key === 'specialization') { // Handle specialization separately
                                character.specialization = Array.isArray(loadedData.specialization) ? loadedData.specialization : [];
                            }
                            else if (typeof character[key] === 'object' && character[key] !== null) {
                                if (typeof loadedData[key] === 'object' && loadedData[key] !== null) {
                                    // Merge loaded stat properties, but ensure maxExperience and total are re-calculated or default
                                    character[key] = {
                                        ...character[key], // Start with default sub-properties (like maxExperience)
                                        ...loadedData[key] // Overlay loaded data
                                    };
                                    // Recalculate total for loaded stats (as it's not saved)
                                    character[key].total = calculateTotal(key);
                                    // Ensure maxExperience is set if it was missing from loaded data
                                    if (typeof character[key].maxExperience === 'undefined' || character[key].maxExperience === null) {
                                        character[key].maxExperience = defaultStatMaxExperience; // Default value
                                    }

                                } else {
                                    character[key] = {
                                        ...character[key],
                                        value: parseFloat(loadedData[key]) || character[key].value
                                    };
                                    character[key].total = calculateTotal(key); // Recalculate total
                                }
                            } else {
                                // For properties like hp, healthBonus, racialPower, currentMagicPoints, ac, skills, inventory, personalNotes
                                // Use the loaded value if it exists, otherwise retain the default
                                if (key === 'hp' || key === 'healthBonus' || key === 'racialPower' || key === 'skills' || key === 'inventory' || key === 'armorBonus' || key === 'personalNotes') { // Added armorBonus and personalNotes
                                    character[key] = loadedData[key];
                                } else if (key === 'currentMagicPoints') { // Handle the renamed magic property
                                    character.currentMagicPoints = loadedData.currentMagicPoints !== undefined ? loadedData.currentMagicPoints : 100;
                                } else {
                                    character[key] = loadedData[key];
                                }
                            }
                        }
                    }

                    // Handle new level experience properties, providing defaults if missing
                    character.levelExperience = loadedData.levelExperience !== undefined ? loadedData.levelExperience : 0;
                    character.levelMaxExperience = loadedData.levelMaxExperience !== undefined ? loadedData.levelMaxExperience : calculateLevelMaxExperience(character.level);

                    // Recalculate maxHp, maxMagicPoints, and maxRacialPower after level, race, and healthBonus are potentially loaded
                    character.maxHp = calculateMaxHealth(character.race, character.level, character.healthBonus);
                    character.maxMagicPoints = calculateMaxMagic(character.level);
                    character.maxRacialPower = calculateMaxRacialPower(character.level);
                    // Recalculate AC after armorBonus is loaded
                    character.ac = character.armorBonus;


                    // Ensure current HP, Magic, and Racial Power don't exceed new max values
                    character.hp = Math.min(character.hp, character.maxHp);
                    character.currentMagicPoints = Math.min(character.currentMagicPoints, character.maxMagicPoints);
                    character.racialPower = Math.min(character.racialPower, character.maxRacialPower);


                    updateDOM(); // Update the UI with loaded data
                    console.log(`Character "${character.name}" loaded from JSON file!`); // Added console log
                } catch (e) {
                    console.error("Error parsing JSON file:", e);
                    // In a real app, you might show a user-friendly error message here
                }
            };
            reader.readAsText(file);
        }

        // Function to update the DOM elements with the current character data
        function updateDOM() {
            // Basic Info
            document.getElementById('name').value = character.name;
            document.getElementById('level').value = character.level;
            document.getElementById('levelExperience').value = character.levelExperience;
            document.getElementById('levelMaxExperience').value = character.levelMaxExperience; // This is readonly

            // Handle race selector placeholder color and update max HP
            const raceSelect = document.getElementById('race');
            raceSelect.value = character.race; // Set the selected race
            if (character.race === '') {
                raceSelect.classList.add('select-placeholder-text');
            } else {
                raceSelect.classList.remove('select-placeholder-text');
            }
            // Recalculate maxHp when race is updated in DOM
            character.maxHp = calculateMaxHealth(character.race, character.level, character.healthBonus);
            // Ensure current HP doesn't exceed new max HP when race changes
            character.hp = Math.min(character.hp, character.maxHp);


            // Handle custom multi-select for class
            const classDisplayInput = document.getElementById('class-display');
            const classDropdownOptions = document.getElementById('class-dropdown-options');

            // Set the displayed value for classes
            classDisplayInput.value = character.class.join(', ');

            // Populate and update checkboxes in the dropdown options
            classDropdownOptions.innerHTML = ''; // Clear existing options
            classOptionsList.forEach(className => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md';
                checkboxDiv.innerHTML = `
                    <input
                        type="checkbox"
                        id="class-${className.replace(/\s/g, '-')}"
                        name="class-option"
                        value="${className}"
                        class="form-checkbox h-4 w-4 text-indigo-600 dark:text-indigo-400 rounded border-gray-300 dark:border-gray-600 focus:ring-indigo-500"
                        ${character.class.includes(className) ? 'checked' : ''}
                    />
                    <label for="class-${className.replace(/\s/g, '-')}" class="ml-2 text-sm text-gray-700 dark:text-gray-300 cursor-pointer">${className}</label>
                `;
                classDropdownOptions.appendChild(checkboxDiv);
            });

            // Update Specialization dropdown
            updateSpecializationDropdownAndData();


            // Player Stats
            const playerStatsContainer = document.getElementById('player-stats-container').querySelector('tbody');
            playerStatsContainer.innerHTML = ''; // Clear existing rows

            playerStatsList.forEach(statName => {
                const statData = character[statName];
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700'; // Add hover effect to rows
                row.innerHTML = `
                    <td class="px-2 py-1 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100 capitalize">${statName}</td>
                    <td class="px-2 py-1 whitespace-nowrap">
                        <input type="number" id="${statName}-value" name="${statName}-value" min="0" value="${statData.value}" class="stat-input" />
                    </td>
                    <td class="px-2 py-1 whitespace-nowrap">
                        <input type="number" id="${statName}-racialChange" name="${statName}-racialChange" value="${statData.racialChange}" class="stat-input" />
                    </td>
                    <td class="px-2 py-1 whitespace-nowrap">
                        <input type="number" id="${statName}-equipment" name="${statName}-equipment" value="${statData.equipment}" class="stat-input" />
                    </td>
                    <td class="px-2 py-1 whitespace-nowrap">
                        <input type="number" id="${statName}-temporary" name="${statName}-temporary" value="${statData.temporary}" class="stat-input" />
                    </td>
                    <td class="px-2 py-1 whitespace-nowrap">
                        <div class="flex items-center justify-center exp-inputs-wrapper">
                            <input type="number" id="${statName}-experience" name="${statName}-experience" min="0" value="${statData.experience}" class="stat-input rounded-r-none" />
                            <span class="px-1 py-1 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs">/</span>
                            <input type="number" id="${statName}-maxExperience" name="${statName}-maxExperience" min="1" value="${statData.maxExperience}" readonly class="stat-input rounded-l-none" />
                        </div>
                    </td>
                    <td class="px-2 py-1 whitespace-nowrap">
                        <input type="number" id="${statName}-total" name="${statName}-total" value="${statData.total}" readonly class="stat-input" />
                    </td>
                `;
                playerStatsContainer.appendChild(row);
            });


            // Health & Combat
            document.getElementById('hp').value = character.hp;
            document.getElementById('maxHp').value = character.maxHp; // This now includes healthBonus
            document.getElementById('healthBonus').value = character.healthBonus; // Populate the separate healthBonus input
            document.getElementById('racialPower').value = character.racialPower; // Populate racialPower
            document.getElementById('maxRacialPower').value = character.maxRacialPower; // Populate maxRacialPower
            document.getElementById('currentMagicPoints').value = character.currentMagicPoints; // Populate currentMagicPoints
            document.getElementById('maxMagicPoints').value = character.maxMagicPoints; // Populate maxMagicPoints
            document.getElementById('ac').value = character.ac; // Populate total armor (readonly)
            document.getElementById('armorBonus').value = character.armorBonus; // Populate armor bonus


            // Skills & Inventory
            document.getElementById('skills').value = character.skills;
            document.getElementById('inventory').value = character.inventory;
            // Personal Notes
            document.getElementById('personalNotes').value = character.personalNotes;
        }

        // Function to perform a quick roll for all player stats
        function quickRollStats() {
            playerStatsList.forEach(statName => {
                // Generate a random number between 6 and 20 (inclusive)
                const max = 20;
                const min = 6;
                const rolledValue = Math.floor(Math.random() * (max - min + 1)) + min;
                character[statName].value = rolledValue; // Assign to the 'value' property

                // Recalculate total for the updated stat
                character[statName].total = calculateTotal(statName);

                // Update the DOM for value and total immediately
                document.getElementById(`${statName}-value`).value = character[statName].value;
                document.getElementById(`${statName}-total`).value = character[statName].total;
            });
            // No saveCharacter here, as it's handled by handleChange for individual inputs
            // or by the saveCharacterToFile for explicit save.
        }

        // Event listener for all input changes (excluding the custom class multi-select)
        function handleChange(event) {
            const { name, id, value, type } = event.target;
            let newValue;

            // This handleChange will now only handle non-class inputs and the race selector
            if (type === 'number') {
                newValue = parseFloat(value) || 0;
            } else {
                newValue = value;
            }

            // Check if the changed input belongs to a player stat
            let isPlayerStatInput = false;
            let statName = '';
            let subProperty = '';

            for (const stat of playerStatsList) {
                if (name.startsWith(`${stat}-`)) {
                    isPlayerStatInput = true;
                    statName = stat;
                    subProperty = name.substring(stat.length + 1); // e.g., 'value', 'racialChange', 'experience', 'maxExperience'
                    break;
                }
            }

            if (isPlayerStatInput) {
                if (subProperty === 'experience') {
                    // Update the experience value directly first
                    character[statName].experience = newValue;

                    // Check if experience has reached or exceeded maxExperience
                    if (character[statName].experience >= character[statName].maxExperience && character[statName].maxExperience > 0) {
                        character[statName].value++; // Increment the stat's value
                        character[statName].experience -= character[statName].maxExperience; // Reset experience
                        // Update the DOM for value and experience immediately
                        document.getElementById(`${statName}-value`).value = character[statName].value;
                        document.getElementById(`${statName}-experience`).value = character[statName].experience;
                    }
                    // Always update the displayed experience, even if it didn't trigger a level up
                    document.getElementById(`${statName}-experience`).value = character[statName].experience;

                } else if (subProperty === 'maxExperience') {
                    // Ensure maxExperience is at least 1
                    character[statName].maxExperience = Math.max(1, newValue);
                    // Update the DOM for maxExperience immediately
                    document.getElementById(`${statName}-maxExperience`).value = character[statName].maxExperience;
                    // Re-evaluate experience if maxExperience changed and current experience is sufficient
                    if (character[statName].experience >= character[statName].maxExperience && character[statName].maxExperience > 0) {
                        character[statName].value++;
                        character[statName].experience -= character[statName].maxExperience;
                        document.getElementById(`${statName}-value`).value = character[statName].value;
                        document.getElementById(`${statName}-experience`).value = character[statName].experience;
                    }

                } else {
                    // For other sub-properties (value, racialChange, equipment, temporary)
                    character[statName][subProperty] = newValue;
                }

                // Recalculate the total for this stat after any change in its sub-properties
                character[statName].total = calculateTotal(statName);
                // Update the total display in the DOM immediately
                document.getElementById(`${statName}-total`).value = character[statName].total;

            } else {
                // For other non-stat inputs (name, level, hp, ac, skills, inventory, race, healthBonus, currentMagicPoints, racialPower, personalNotes)
                // The 'class-display' input is read-only and handled by custom logic, so it's excluded here.
                if (id === 'levelExperience') {
                    character.levelExperience = newValue;
                    if (character.levelExperience >= character.levelMaxExperience) {
                        character.level++;
                        character.levelExperience -= character.levelMaxExperience;
                        character.levelMaxExperience = calculateLevelMaxExperience(character.level);
                        document.getElementById('level').value = character.level;
                        document.getElementById('levelMaxExperience').value = character.levelMaxExperience;
                    }
                    document.getElementById('levelExperience').value = character.levelExperience;
                } else if (id === 'level') {
                    character.level = newValue;
                    character.levelMaxExperience = calculateLevelMaxExperience(character.level);
                    document.getElementById('levelMaxExperience').value = character.levelMaxExperience;
                    // Also update maxHp, maxMagicPoints and maxRacialPower when level changes
                    character.maxHp = calculateMaxHealth(character.race, character.level, character.healthBonus);
                    character.hp = Math.min(character.hp, character.maxHp); // Adjust current HP if it exceeds new max
                    document.getElementById('maxHp').value = character.maxHp;
                    document.getElementById('hp').value = character.hp;

                    character.maxMagicPoints = calculateMaxMagic(character.level);
                    character.currentMagicPoints = Math.min(character.currentMagicPoints, character.maxMagicPoints); // Adjust current Magic if it exceeds new max
                    document.getElementById('maxMagicPoints').value = character.maxMagicPoints;
                    document.getElementById('currentMagicPoints').value = character.currentMagicPoints;

                    character.maxRacialPower = calculateMaxRacialPower(character.level);
                    character.racialPower = Math.min(character.racialPower, character.maxRacialPower); // Adjust current Racial Power if it exceeds new max
                    document.getElementById('maxRacialPower').value = character.maxRacialPower;
                    document.getElementById('racialPower').value = character.racialPower;

                } else if (id === 'race') {
                    character.race = newValue;
                    const raceSelect = document.getElementById('race');
                    if (newValue === '') {
                        raceSelect.classList.add('select-placeholder-text');
                    } else {
                        raceSelect.classList.remove('select-placeholder-text');
                    }
                    // Update maxHp when race changes
                    character.maxHp = calculateMaxHealth(character.race, character.level, character.healthBonus);
                    character.hp = Math.min(character.hp, character.maxHp); // Adjust current HP if it exceeds new max
                    document.getElementById('maxHp').value = character.maxHp;
                    document.getElementById('hp').value = character.hp;
                } else if (id === 'hp') { // Handle current HP input
                    character.hp = Math.min(newValue, character.maxHp); // Ensure current HP doesn't exceed max HP
                    document.getElementById('hp').value = character.hp;
                } else if (id === 'currentMagicPoints') { // Handle current Magic input (renamed)
                    character.currentMagicPoints = Math.min(newValue, character.maxMagicPoints); // Ensure current Magic doesn't exceed max Magic
                    document.getElementById('currentMagicPoints').value = character.currentMagicPoints;
                } else if (id === 'racialPower') { // Handle current Racial Power input
                    character.racialPower = Math.min(newValue, character.maxRacialPower); // Ensure current Racial Power doesn't exceed max Racial Power
                    document.getElementById('racialPower').value = character.racialPower;
                } else if (id === 'healthBonus') { // Handle healthBonus input
                    character.healthBonus = newValue;
                    // Recalculate maxHp when healthBonus changes
                    character.maxHp = calculateMaxHealth(character.race, character.level, character.healthBonus);
                    character.hp = Math.min(character.hp, character.maxHp); // Adjust current HP if it exceeds new max
                    document.getElementById('maxHp').value = character.maxHp;
                    document.getElementById('hp').value = character.hp;
                } else if (id === 'armorBonus') { // Handle armorBonus input
                    character.armorBonus = newValue;
                    character.ac = character.armorBonus; // Update AC based on armorBonus
                    document.getElementById('ac').value = character.ac; // Update readonly AC input
                } else if (id === 'personalNotes') { // Handle personalNotes input
                    character.personalNotes = newValue;
                }
                else if (id !== 'class-display' && id !== 'specialization-display') { // Exclude specialization-display
                    character[name || id] = newValue;
                }
            }
            // No saveCharacter here, as it's handled by saveCharacterToFile for explicit save.
        }

        // Function to toggle the visibility of the class dropdown options
        function toggleClassDropdown() {
            const dropdown = document.getElementById('class-dropdown-options');
            dropdown.classList.toggle('hidden');
        }

        // Function to toggle the visibility of the specialization dropdown options
        function toggleSpecializationDropdown() {
            const dropdown = document.getElementById('specialization-dropdown-options');
            dropdown.classList.toggle('hidden');
        }

        // Function to handle changes in the class checkboxes
        function handleClassCheckboxChange(event) {
            const { value, checked } = event.target;

            if (checked) {
                if (!character.class.includes(value)) {
                    character.class.push(value);
                }
            } else {
                character.class = character.class.filter(c => c !== value);
            }
            // Update the displayed value in the input field
            document.getElementById('class-display').value = character.class.join(', ');

            // After class changes, update specialization dropdown
            updateSpecializationDropdownAndData();
            // No saveCharacter here, as it's handled by saveCharacterToFile for explicit save.
        }

        // Function to handle changes in the specialization checkboxes
        function handleSpecializationCheckboxChange(event) {
            const { value, checked } = event.target;

            if (checked) {
                if (!character.specialization.includes(value)) {
                    character.specialization.push(value);
                }
            } else {
                character.specialization = character.specialization.filter(s => s !== value);
            }
            // Update the displayed value in the input field
            document.getElementById('specialization-display').value = character.specialization.join(', ');
            // No saveCharacter here, as it's handled by saveCharacterToFile for explicit save.
        }

        // Function to update the specialization dropdown options and filter selected specializations
        function updateSpecializationDropdownAndData() {
            const specializationDisplayInput = document.getElementById('specialization-display');
            const specializationDropdownOptions = document.getElementById('specialization-dropdown-options');

            // 1. Determine available specializations based on selected classes
            const availableSpecializationsSet = new Set();
            character.class.forEach(selectedClass => {
                if (classSpecializationsMap[selectedClass]) {
                    classSpecializationsMap[selectedClass].forEach(spec => availableSpecializationsSet.add(selectedClass + "" + spec));
                }
            });
            const availableSpecializations = Array.from(availableSpecializationsSet).sort();

            // 2. Filter character.specialization to keep only valid ones
            character.specialization = character.specialization.filter(spec => availableSpecializations.includes(spec));

            // 3. Update the displayed value for specializations
            specializationDisplayInput.value = character.specialization.join(', ');

            // 4. Populate and update checkboxes in the dropdown options
            specializationDropdownOptions.innerHTML = ''; // Clear existing options
            if (availableSpecializations.length === 0) {
                specializationDropdownOptions.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400">No specializations available for selected classes.</div>';
            } else {
                availableSpecializations.forEach(specName => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md';
                    checkboxDiv.innerHTML = `
                        <input
                            type="checkbox"
                            id="specialization-${specName.replace(/\s/g, '-')}"
                            name="specialization-option"
                            value="${specName}"
                            class="form-checkbox h-4 w-4 text-indigo-600 dark:text-indigo-400 rounded border-gray-300 dark:border-gray-600 focus:ring-indigo-500"
                            ${character.specialization.includes(specName) ? 'checked' : ''}
                        />
                        <label for="specialization-${specName.replace(/\s/g, '-')}" class="ml-2 text-sm text-gray-700 dark:text-gray-300 cursor-pointer">${specName}</label>
                    `;
                    specializationDropdownOptions.appendChild(checkboxDiv);
                });
            }
        }

        // Function to toggle the personal notes modal
        function toggleNotesModal() {
            const notesModal = document.getElementById('notes-modal');
            const personalNotesTextarea = document.getElementById('personalNotes');

            if (notesModal.classList.contains('hidden')) {
                // Show modal: populate textarea with current notes
                personalNotesTextarea.value = character.personalNotes;
                notesModal.classList.remove('hidden');
            } else {
                // Hide modal: save textarea content to character data
                character.personalNotes = personalNotesTextarea.value;
                notesModal.classList.add('hidden');
            }
        }


        // Attach event listeners to all relevant input fields
        function attachEventListeners() {
            // Attach listeners for standard inputs and the race selector
            const inputs = document.querySelectorAll(
                '#name, #level, #levelExperience, #race, #hp, #currentMagicPoints, #racialPower, #skills, #inventory, #healthBonus, #armorBonus' // Added armorBonus
            );
            inputs.forEach(input => {
                if (!input.readOnly) {
                    input.addEventListener('input', handleChange);
                }
            });

            // Attach listeners for stat table inputs using delegation
            document.getElementById('player-stats-container').addEventListener('input', function(event) {
                if (event.target.classList.contains('stat-input')) {
                    handleChange(event);
                }
            });


            // Attach event listener for the custom class display input to toggle dropdown
            document.getElementById('class-display').addEventListener('click', toggleClassDropdown);

            // Attach event listeners to the dynamically created class checkboxes (delegation)
            document.getElementById('class-dropdown-options').addEventListener('change', function(event) {
                if (event.target.type === 'checkbox' && event.target.name === 'class-option') {
                    handleClassCheckboxChange(event);
                }
            });

            // Attach event listener for the custom specialization display input to toggle dropdown
            document.getElementById('specialization-display').addEventListener('click', toggleSpecializationDropdown);

            // Attach event listeners to the dynamically created specialization checkboxes (delegation)
            document.getElementById('specialization-dropdown-options').addEventListener('change', function(event) {
                if (event.target.type === 'checkbox' && event.target.name === 'specialization-option') {
                    handleSpecializationCheckboxChange(event);
                }
            });

            // Close dropdowns if clicked outside
            document.addEventListener('click', function(event) {
                const classDisplayInput = document.getElementById('class-display');
                const classDropdownOptions = document.getElementById('class-dropdown-options');
                const specializationDisplayInput = document.getElementById('specialization-display');
                const specializationDropdownOptions = document.getElementById('specialization-dropdown-options');

                if (!classDisplayInput.contains(event.target) && !classDropdownOptions.contains(event.target)) {
                    classDropdownOptions.classList.add('hidden');
                }
                if (!specializationDisplayInput.contains(event.target) && !specializationDropdownOptions.contains(event.target)) {
                    specializationDropdownOptions.classList.add('hidden');
                }
            });


            // Attach event listener for the Quick Roll Stats button
            document.getElementById('quick-roll-stats-btn').addEventListener('click', quickRollStats);

            // Attach event listeners for Save/Load JSON buttons
            document.getElementById('save-json-btn').addEventListener('click', saveCharacterToFile);
            document.getElementById('load-json-btn').addEventListener('click', () => {
                document.getElementById('load-json-input').click(); // Trigger file input click
            });
            document.getElementById('load-json-input').addEventListener('change', loadCharacterFromFile);

            // Attach event listeners for Personal Notes button and modal close button
            document.getElementById('toggle-notes-btn').addEventListener('click', toggleNotesModal);
            document.getElementById('close-notes-modal-btn').addEventListener('click', toggleNotesModal);
        }

        // Initialize the application when the DOM is fully loaded
        window.onload = function() {
            // Initialize maxHp, maxMagicPoints and maxRacialPower based on default race, level, and healthBonus
            character.maxHp = calculateMaxHealth(character.race, character.level, character.healthBonus);
            character.maxMagicPoints = calculateMaxMagic(character.level);
            character.maxRacialPower = calculateMaxRacialPower(character.level);
            // Initialize AC based on armorBonus
            character.ac = character.armorBonus;
            updateDOM();
            attachEventListeners(); // Attach event listeners after DOM is updated
        };
    </script>
</body>
