<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Sheet</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="Sheet.css" rel="stylesheet">
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex">
    <!-- Left Side Panel -->
    <!-- This panel is fixed on the left and contains all the previous header elements -->
    <!-- Added 'transition-all duration-300 ease-in-out' for smooth animation -->
    <aside id="left-sidebar" class="fixed left-0 top-0 h-full w-64 bg-indigo-800 dark:bg-indigo-950 shadow-lg p-4 flex flex-col space-y-4 z-20 overflow-y-auto transition-all duration-300 ease-in-out">
        <h2 class="text-2xl font-bold text-white text-center mb-4">Controls</h2>

        <!-- Toggle Button for Sidebar -->
        <button id="sidebar-toggle-btn" class="absolute -right-3 top-2/2 -translate-y-1/2 bg-indigo-600 hover:bg-indigo-700 text-white p-1 rounded-full shadow-lg focus:outline-none z-30">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </button>

        <!-- Save Dropdown -->
        <div class="dropdown-container w-full">
            <button id="save-dropdown-btn"
                    class="px-6 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200 flex items-center justify-center w-full">
                üíæ Save <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="save-dropdown-menu" class="dropdown-menu hidden left-0 right-0">
                <button id="save-current-system-btn">Current System (JSON)</button>
                <button id="save-google-drive-btn">Google Drive</button>
            </div>
        </div>

        <!-- Load Dropdown -->
        <div class="dropdown-container w-full">
            <button id="load-dropdown-btn"
                    class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200 flex items-center justify-center w-full">
                üìÇ Load <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="load-dropdown-menu" class="dropdown-menu hidden left-0 right-0">
                <input type="file" id="load-json-input" accept=".json" class="hidden"/>
                <button id="load-current-system-btn">Current System (JSON)</button>
                <button id="load-google-drive-btn">Google Drive</button>
            </div>
        </div>

        <button id="new-file-btn"
                class="px-6 py-2 bg-yellow-600 text-white font-semibold rounded-md shadow-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200 w-full">
            üìÑ New File
        </button>

        <!-- New End Turn Button -->
        <button id="end-turn-btn"
                class="px-6 py-2 bg-red-600 text-white font-semibold rounded-md shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200 w-full">
            End Turn
        </button>

        <!-- New Character Selector and Add Button -->
        <div class="flex flex-col items-center space-y-2 w-full">
            <select id="character-selector"
                    class="px-4 py-2 bg-gray-700 text-white font-semibold rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200 w-full">
                <!-- Options will be populated by JS -->
            </select>
            <button id="add-character-btn"
                    class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200 w-full">
                Add New Character
            </button>
        </div>
        <!-- Google Drive Auth Status and Button -->
        <div class="flex flex-col items-center space-y-2 w-full mt-4">
            <span id="google-drive-auth-status" class="text-sm text-gray-300">Google Drive: Not Authorized</span>
            <button id="authorize_google_drive_button" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-md shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200 w-full">
                Authorize Google Drive
            </button>
            <button id="signout_google_drive_button" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-md shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200 hidden w-full">
                Sign Out Google Drive
            </button>
        </div>
        <span id="status-message" class="text-gray-300 w-full text-center mt-4"></span>
    </aside>

    <!-- Main Content Area -->
    <!-- Added 'transition-all duration-300 ease-in-out' for smooth animation -->
    <main id="main-content" class="flex-1 ml-64 p-4 md:p-6 lg:p-8 transition-all duration-300 ease-in-out">
        <div class="w-full max-w-5xl lg:max-w-6xl bg-white dark:bg-gray-800 rounded-xl shadow-2xl mx-auto">
            <div class="sticky top-0 z-10 bg-white dark:bg-gray-800 p-4 md:p-6 lg:p-8 rounded-t-xl shadow-md">
                <div class="flex items-center justify-between">
                    <h1 class="text-4xl font-bold text-indigo-700 dark:text-indigo-400">
                        Character Sheet
                    </h1>
                    <div class="flex space-x-2">
                        <button id="toggle-notes-btn"
                                class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-md shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                            Personal Notes
                        </button>

                        <button onclick="print()"
                                class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-md shadow-md hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">üñ®Ô∏è Print</button>
                        <button id="revert-character-btn"
                                class="px-4 py-2 bg-orange-500 text-white font-semibold rounded-md shadow-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                            Revert
                        </button>
                        <button id="forward-character-btn"
                                class="px-4 py-2 bg-teal-500 text-white font-semibold rounded-md shadow-md hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                            Forward
                        </button>
                        <button id="reset-character-btn"
                                class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-md shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                            Reset
                        </button>
                        <button id="delete-character-btn"
                                class="px-4 py-2 bg-red-500 text-white font-semibold rounded-md shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                            Delete
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Basic Info</h2>
                    <button class="toggle-section-btn text-indigo-600 dark:text-indigo-300 hover:text-indigo-800 dark:hover:text-indigo-100 transition-colors duration-200" data-target="basic-info-content">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="basic-info-content" class="section-content">
                    <!-- Grid layout responsive: 1 column on small, 2 on medium+ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Character Name</label>
                            <input
                                type="text"
                                id="name"
                                name="name"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                                placeholder="e.g., Elara Whisperwind"
                            />
                        </div>
                        <div>
                            <label for="classes-display" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Class</label>
                            <div class="relative">
                                <input
                                    type="text"
                                    id="classes-display"
                                    name="classes-display"
                                    readonly
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 cursor-pointer"
                                    placeholder="Select classes..."
                                />
                                <div id="classes-dropdown-options" class="absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto">
                                    <!-- Options will be dynamically populated here by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <!-- specializations Section -->
                        <div>
                            <label for="specializations-display" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Specialization</label>
                            <div class="relative">
                                <input
                                    type="text"
                                    id="specializations-display"
                                    name="specializations-display"
                                    readonly
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 cursor-pointer"
                                    placeholder="No specializations available"
                                />
                                <div id="specializations-dropdown-options" class="absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto">
                                    <!-- Options will be dynamically populated here by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="race" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Race</label>
                            <select
                                id="race"
                                name="race"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 dark:text-gray-100 select-placeholder-text">
                                <option value="" disabled selected class="defaultOption">Select a Race</option>
                            </select>
                        </div>
                        <div>
                            <label for="level" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Level</label>
                            <input
                                type="number"
                                id="level"
                                name="level"
                                min="1"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Level Experience</label>
                            <div class="flex items-center mt-1">
                                <input
                                    type="number"
                                    id="levelExperience"
                                    name="levelExperience"
                                    min="0"
                                    class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                                />
                                <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                                <input
                                    type="number"
                                    id="levelMaxExperience"
                                    name="levelMaxExperience"
                                    min="1"
                                    class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                                    readonly
                                />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Passives Section -->
            <div id="racial-passives-section" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Racial Passives</h2>
                    <button class="toggle-section-btn text-indigo-600 dark:text-indigo-300 hover:text-indigo-800 dark:hover:text-indigo-100 transition-colors duration-200" data-target="racial-passives-content">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="racial-passives-content" class="section-content">
                    <div id="racial-manual-passives-container" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-4 hidden"></div>

                    <div id="racial-regular-passives-container" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow hidden"></div>
                </div>
                <div id="classes-passives-content" class="section-content">
                    <div id="classes-manual-passives-container" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-4 hidden"></div>

                    <div id="classes-regular-passives-container" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow hidden"></div>
                </div>
            </div>

            <!-- Player Stats Section -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Player Stats</h2>
                    <button class="toggle-section-btn text-indigo-600 dark:text-indigo-300 hover:text-indigo-800 dark:hover:text-indigo-100 transition-colors duration-200" data-target="player-stats-content">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="player-stats-content" class="section-content">
                    <div class="flex items-center space-x-4 mb-4">
                        <button id="quick-roll-stats-btn"
                                class="px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                            Quick Roll Stats
                        </button>
                        <button id="distribute-stats-btn"
                                class="px-4 py-2 bg-green-500 text-white font-semibold rounded-md shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                            Distribute 97 Points
                        </button>
                        <span id="remaining-points" class="text-lg font-bold text-gray-700 dark:text-gray-300">Points Left: 0</span>
                    </div>
                    <div id="player-stats-container" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 rounded-lg shadow-md">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-2 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Stat Name</th>
                                    <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Value</th>
                                    <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Racial</th>
                                    <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Equip</th>
                                    <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Exp</th>
                                    <th scope="col" class="px-2 py-2 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Player stats rows will be dynamically populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Health & Combat Section -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Health & Combat</h2>
                    <button class="toggle-section-btn text-indigo-600 dark:text-indigo-300 hover:text-indigo-800 dark:hover:text-indigo-100 transition-colors duration-200" data-target="health-combat-content">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="health-combat-content" class="section-content">
                    <div>
                        <label for="state-display" class="block text-sm font-medium text-gray-700 dark:text-gray-300">States</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="state-display"
                                name="state-display"
                                readonly
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 cursor-pointer"
                                placeholder="Select states..."
                            />
                            <div id="state-dropdown-options" class="absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg mt-1 hidden max-h-48 overflow-y-auto">
                            </div>
                        </div>
                    </div>
                    <br>
                    <button id="take-damage-btn"
                        class="p-0.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center gap-1 text-sm font-medium text-gray-700 dark:text-gray-300">
                        üí• Take Damage
                    </button>
                    <br>
                    <!-- Grid layout responsive: 1 column on small, 2 on medium+ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Health / Max Health -->
                        <div>
                            <button type="button"
                                class="temp-effects-btn p-0.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center gap-1 text-sm font-medium text-gray-700 dark:text-gray-300"
                                data-stat-name="Health" data-stat-display-name="Health" data-stat-display-total="maxHealth">
                                Health
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="flex items-center mt-1">
                                <input
                                    type="number"
                                    id="Health"
                                    name="Health"
                                    min="0"
                                    class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                                />
                                <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                                <input
                                    type="number"
                                    id="maxHealth"
                                    name="maxHealth"
                                    min="0"
                                    class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                                    readonly
                                />
                            </div>
                        </div>
                        <!-- Racial Power / Max Racial Power Input -->
                        <div>
                            <button type="button"
                                class="temp-effects-btn p-0.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center gap-1 text-sm font-medium text-gray-700 dark:text-gray-300"
                                data-stat-name="RacialPower" data-stat-display-name="Racial Power" data-stat-display-total="maxRacialPower">
                                Racial Power
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="flex items-center mt-1">
                                <input
                                    type="number"
                                    id="RacialPower"
                                    name="RacialPower"
                                    class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                                />
                                <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                                <input
                                    type="number"
                                    id="maxRacialPower"
                                    name="maxRacialPower"
                                    min="0"
                                    class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                                    readonly
                                />
                            </div>
                        </div>
                        <!-- Mana / Max Mana Input -->
                        <div>
                            <button type="button"
                                class="temp-effects-btn p-0.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center gap-1 text-sm font-medium text-gray-700 dark:text-gray-300"
                                data-stat-name="Mana" data-stat-display-name="Mana" data-stat-display-total="maxMana">
                                Mana
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="flex items-center mt-1">
                                <input
                                    type="number"
                                    id="Mana"
                                    name="Mana"
                                    min="0"
                                    class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-center"
                                />
                                <span class="px-2 py-2 border-y border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm">/</span>
                                <input
                                    type="number"
                                    id="maxMana"
                                    name="maxMana"
                                    min="0"
                                    class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-r-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                                    readonly
                                />
                            </div>
                        </div>
                        <!-- Total defense -->
                        <div>
                            <button type="button"
                                class="temp-effects-btn p-0.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center gap-1 text-sm font-medium text-gray-700 dark:text-gray-300"
                                data-stat-name="totalDefense" data-stat-display-name="Total Defense" data-stat-display-total="totalDefense">
                                Total defense
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="flex items-center mt-1">
                                <input
                                    type="number"
                                    id="total-defense"
                                    name="totalDefense"
                                    min="0"
                                    class="w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 cursor-not-allowed text-center"
                                    readonly
                                />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actives Section -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Actives</h2>
                    <button class="toggle-section-btn text-indigo-600 dark:text-indigo-300 hover:text-indigo-800 dark:hover:text-indigo-100 transition-colors duration-200" data-target="actives-content">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="actives-content" class="section-content">
                    <div id="racial-actives-container" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-4 hidden"></div>
                    <div id="classes-actives-container" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-4 hidden"></div>
                </div>
            </div>

            <!-- Weapon Inventory Section -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Weapon Inventory</h2>
                    <button class="toggle-section-btn text-indigo-600 dark:text-indigo-300 hover:text-indigo-800 dark:hover:text-indigo-100 transition-colors duration-200" data-target="weapon-inventory-content">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="weapon-inventory-content" class="section-content">
                    <button id="add-weapon-btn"
                            class="mb-4 px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                        Add Weapon
                    </button>
                    <div class="inventory-table-container">
                        <table id="weapon-inventory-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 rounded-lg shadow-md">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Material</th>
                                    <th>Requirement</th>
                                    <th>Required Stat</th>
                                    <th>Accuracy</th>
                                    <th>Damage</th>
                                    <th>Magic Damage</th>
                                    <th>Magic Type</th>
                                    <th>Effect</th>
                                    <th>Value</th>
                                    <th>Use</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Weapon rows will be dynamically populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Armor Inventory Section -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Armor Inventory</h2>
                    <button class="toggle-section-btn text-indigo-600 dark:text-indigo-300 hover:text-indigo-800 dark:hover:text-indigo-100 transition-colors duration-200" data-target="armor-inventory-content">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="armor-inventory-content" class="section-content">
                    <button id="add-armor-btn"
                            class="mb-4 px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                        Add Armor
                    </button>
                    <div class="inventory-table-container">
                        <table id="armor-inventory-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 rounded-lg shadow-md">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th>Name</th>
                                    <th>Location</th>
                                    <th>Material</th>
                                    <th>Requirement</th>
                                    <th>Required Stat</th>
                                    <th>Defense</th>
                                    <th>Magic Defense</th>
                                    <th>Magic Type</th>
                                    <th>Effect</th>
                                    <th>Value</th>
                                    <th>Equipped</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Armor rows will be dynamically populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- General Inventory Section -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Inventory</h2>
                    <button class="toggle-section-btn text-indigo-600 dark:text-indigo-300 hover:text-indigo-800 dark:hover:text-indigo-100 transition-colors duration-200" data-target="general-inventory-content">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="general-inventory-content" class="section-content">
                    <button id="add-general-item-btn"
                            class="mb-4 px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                        Add Item
                    </button>
                    <div class="inventory-table-container">
                        <table id="general-inventory-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 rounded-lg shadow-md">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Effect</th>
                                    <th>Accuracy</th>
                                    <th>Amount</th>
                                    <th>Value (per unit)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- General item rows will be dynamically populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- coins Section -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Purse and Bank</h2>
                    <button class="toggle-section-btn text-indigo-600 dark:text-indigo-300 hover:text-indigo-800 dark:hover:text-indigo-100 transition-colors duration-200" data-target="coins-content">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="coins-content" class="section-content">
                    <div class="mt-2 space-y-2">
                    <div>
                        <label for="purse" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Purse</label>
                        <input
                            type="number"
                            id="purse"
                            name="purse"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                        />
                    </div>
                    <div>
                        <label for="bank" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Bank</label>
                        <input
                            type="number"
                            id="bank"
                            name="bank"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
                        />
                    </div>
                </div>
                </div>
            </div>

            <!-- Backstory Section -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300">Backstory</h2>
                    <button class="toggle-section-btn text-indigo-600 dark:text-indigo-300 hover:text-indigo-800 dark:hover:text-indigo-100 transition-colors duration-200" data-target="backstory-content">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div id="backstory-content" class="section-content">
                    <textarea id="backstory" name="backstory" rows="6" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100" placeholder="Write the character's history, background, and lore here..."></textarea>
                    <div id="backstory-resizer" class="custom-heigth-resizer"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Personal Notes Panel (Movable and Resizable) -->
    <div id="personal-notes-panel" class="personal-notes-panel hidden">
        <div class="personal-notes-header cursor-grab bg-indigo-700 dark:bg-indigo-900 text-white p-3 rounded-t-lg flex justify-between items-center">
            <h2 class="text-lg font-semibold">Personal Notes</h2>
            <button id="close-notes-panel-btn" class="text-white hover:text-gray-200 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <textarea
            id="personalNotes"
            name="personalNotes"
            class="personal-notes-textarea w-full px-3 py-2 border-t border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
            placeholder="Write your personal notes here..."
        ></textarea>
        <div id="personalNotes-resizer" class="custom-resizer"></div>
    </div>

    <!-- Google Drive File List Modal -->
    <div id="google-drive-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="close-google-drive-modal">&times;</span>
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Select a Google Drive File</h2>
            <ul id="google-drive-file-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Files will be loaded here -->
            </ul>
            <p id="google-drive-modal-status" class="text-sm text-gray-500 mt-2"></p>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="confirm-message" class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-md shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                    OK
                </button>
                <button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-md shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Temporary Effects Modal -->
    <div id="temp-effects-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-lg w-full text-left relative">
            <button id="close-temp-effects-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 id="temp-effects-modal-title" class="text-2xl font-semibold mb-4 text-indigo-600 dark:text-indigo-300">Temporary Effects for [Stat Name]</h2>
            <div class="relative max-h-80 overflow-hidden border border-gray-200 dark:border-gray-700 rounded-md">
                <!-- Scrollable List -->
                <div id="temp-effects-list" class="p-4 overflow-y-auto max-h-64 pr-2 pb-[4.5rem]">
                    <!-- Temporary effects will be populated here -->
                </div>

                <!-- Sticky Button at Bottom -->
                <div class="absolute bottom-0 left-0 w-full bg-white dark:bg-gray-900 p-2 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <button id="add-temp-effect-btn" class="w-full px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                        Add Temporary Effect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- take Damage Modal -->
    <div id="take-damage-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <button id="close-take-damage-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-semibold mb-4 text-red-600 dark:text-red-400">Apply Damage</h2>

            <label class="flex items-center space-x-2 mb-4">
                <input type="checkbox" id="set-health-checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <span class="text-sm text-gray-700 dark:text-gray-300">Set health to this value (instead of subtracting)</span>
            </label>

            <label class="flex items-center space-x-2 mb-4">
                <input type="checkbox" id="set-take-true-damage-checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <span class="text-sm text-gray-700 dark:text-gray-300">True damage (currently can bypass some passives)</span>
            </label>

            <label for="damage-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Damage / New Health
            </label>
            <input type="number" id="take-damage-amount" min="0"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
            />

            <div class="mt-6 flex justify-end space-x-2">
                <button id="cancel-take-damage" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-md shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400">
                    Cancel
                </button>
                <button id="apply-take-damage" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-md shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                    Apply
                </button>
            </div>
        </div>
    </div>


    <script>
        window.gapiInited = false;
        window.gisInited = false;
        window.tokenClient = null;

        function gapiLoaded() {
            gapi.load('client', async () => {
            try {
                await gapi.client.load('drive', 'v3'); // ‚úÖ Use manual API load instead of discovery doc
                window.gapiInited = true;
                console.log("‚úÖ GAPI Client Loaded via .load('drive', 'v3')");
                document.dispatchEvent(new Event("gapi-ready"));
            } catch (err) {
                console.error("‚ùå GAPI Manual Load Failed:", err);
            }
            });
        }

        /**
         * Initializes Google Identity Services (GIS) client for authorization.
         */
        function gisLoaded() {
            const Auth_CLIENT_ID = '527331500399-1kmgdnjjlbkv7jtkmrsqh1mlbga6fomf.apps.googleusercontent.com';

            const SCOPES = 'https://www.googleapis.com/auth/drive.file'; // Scope for accessing files created/opened by this app
            const ORIGIN = window.location.origin;

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: Auth_CLIENT_ID,
                scope: SCOPES,
                callback: () => {}, 
                redirect_uri: ORIGIN
            });

            window.gisInited = true;
            console.log("‚úÖ GIS Initialized");
            document.dispatchEvent(new Event("gis-ready"));
        }
    </script>

    <!-- Google API Scripts -->
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded"></script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js"></script>
    <script src="scripts/Sheet.js" type="module"></script>
</body>
</html>